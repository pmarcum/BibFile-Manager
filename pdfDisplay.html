<!doctype html>
<html lang="en">
  <head>
    <base target="_top">
    <!-- Required meta tags -->
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no">
    <link rel="stylesheet" href="//code.jquery.com/ui/1.11.4/themes/smoothness/jquery-ui.css" type="text/css" >
    <link rel="stylesheet" href="//mozilla.github.io/pdf.js/web/viewer.css" type="text/css" />
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.4/jquery.min.js" crossorigin="anonymous" type="text/javascript"></script>
    <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js" crossorigin="anonymous" type="text/javascript"></script>    
    <script src="//mozilla.github.io/pdf.js/build/pdf.js" crossorigin="anonymous" type="text/javascript"></script>
   <!--https://stackoverflow.com/questions/33063213/pdf-js-with-text-selection-->
    <style>
        #scrollbar-helper {position: absolute;top: -100%; overflow: scroll;}
        /* The dropdown header is the main tag category that appears along the top of screen */
       .dropdown-header {background-color: #c2d7cd; color: black; cursor: pointer; padding-left: 6px; padding-right: 6px; 
                         padding-top: 2px; padding-bottom: 2px; font-size: 12px; border: none; border-radius: 8px; margin-bottom:2px;}
       .dropdown-header:hover {background-color: #3e8e41;}
       .dropdown-headerFlagged {background-color: #b497b4; color: black; cursor: pointer; padding-left: 6px; padding-right: 6px; 
                                padding-top: 2px; padding-bottom: 2px; font-size: 12px; border: none; border-radius: 8px; margin-bottom:2px}
       .dropdown-headerFlagged:hover {background-color: #765676;}
       .checkboxLabel {margin-bottom:2px}
       /* the dropdown is a container <div> needed to position the dropdown content */
       .dropdown1 {position:relative; display:inline-block;}
       .dropdown2 {position:relative; display:block;}
       .checkboxContainer {position:relative; display:block;}
       /* Dropdown content is hidden by default */
       .dropdown-contentNormal {position:absolute; display: none; top:12px; left:0px; padding-top:50px; padding-left:10px; padding-right:20px; padding-bottom:30px; 
                                min-width: 200px; background-color:#f1f1f133; box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.2);}
       .dropdownSubmenu2-contentNormal {position:absolute; display: none; top:-10px; left:40px; padding-left:2px; padding-right:20px; padding-top:30px; padding-bottom:30px;
                                        min-width: 200px; background-color:#f1f1f133; box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.2);}
       .dropdownSubmenu3-contentNormal {position:absolute; display: none; top:-10px; left:40px; padding-left:2px; padding-right:20px; padding-top:30px; padding-bottom:30px;
                                        min-width: 200px; background-color:#f1f1f133; box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.2);}
       .dropdownSubmenu4-contentNormal {position:absolute; display: none; top:-10px; left:40px; padding-left:2px; padding-right:20px; padding-top:30px; padding-bottom:30px;
                                        min-width: 200px; background-color:#f1f1f133; box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.2);}
       .dropdownSubmenu5-contentNormal {position:absolute; display: none; top:-10px; left:40px; padding-left:2px; padding-right:20px; padding-top:30px; padding-bottom:30px;
                                        min-width: 200px; background-color:#f1f1f133; box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.2);}
       .dropdown-contentRightEdge {position:absolute; display: none; top:12px; right:0px; padding-top:50px; padding-left:20px; padding-right:10px; padding-bottom:30px; 
                                   min-width: 200px; background-color:#f1f1f133; box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.2);}
       .dropdownSubmenu2-contentRightEdge {position:absolute; display: none; top:8px; right:40px; padding-left:20px; padding-right:2px; padding-top:10px; padding-bottom:30px;
                                           min-width: 200px; background-color:#f1f1f133; box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.2);}
       .dropdownSubmenu3-contentRightEdge {position:absolute; display: none; top:8px; right:40px; padding-left:20px; padding-right:2px; padding-top:10px; padding-bottom:30px;
                                           min-width: 200px; background-color:#f1f1f133; box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.2);}
       .dropdownSubmenu4-contentRightEdge {position:absolute; display: none; top:8px; right:40px; padding-left:20px; padding-right:2px; padding-top:10px; padding-bottom:30px;
                                           min-width: 200px; background-color:#f1f1f133; box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.2);}
       .dropdownSubmenu5-contentRightEdge {position:absolute; display: none; top:8px; right:40px; padding-left:20px; padding-right:2px; padding-top:10px; padding-bottom:30px;
                                           min-width: 200px; background-color:#f1f1f133; box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.2);}
       .turnIntoSubmenuDiv {position:absolute; display: none; top:-15px; left:190px; padding-right:0px; padding-top:10px; background-color:#f1f1f133; min-width:40px}
       .turnIntoSubmenuBtn {background-color:#3333cc99; color:white; padding:10px; font-size:12px; border: none; border-radius: 3px;}
       .turnIntoSubmenuBtn:hover {background-color:#3333cc;}
       .dropdown-content-container1 {padding-top:1px; background-color: #EDEAF1; border:1px solid grey}
       .dropdown-content-container2 {padding-top:1px; background-color: #D7D9E6; border:1px solid grey}
       .dropdown-content-container3 {padding-top:1px; background-color: #DCE8E8; border:1px solid grey}
       .dropdown-content-container4 {padding-top:1px; background-color: #FEFCF5; border:1px solid grey}
       .dropdown-content-container5 {padding-top:1px; background-color: #F4FFFF; border:1px solid grey}
       /* highlight and magnify dropdown link when hovered-over */
       .dropdown-content-container1 .tagsOnlyContainer .checkboxContainer:hover .checkboxLabel {background-color: yellow; font-size: 15px;}
       .dropdown-content-container1 .addtag:hover {background-color: purple; font-size: 15px;}
       .dropdown-content-container1 .addSubmenu:hover {background-color: purple; font-size: 15px;}
       .dropdown-content-container1  a:hover {background-color: yellow; font-size: 15px;}
       .dropdown-content-container2 .tagsOnlyContainer .checkboxContainer:hover .checkboxLabel {background-color: yellow; font-size: 15px;}
       .dropdown-content-container2 .addtag:hover {background-color: purple; font-size: 15px;}
       .dropdown-content-container2 .addSubmenu:hover {background-color: purple; font-size: 15px;}
       .dropdown-content-container2  a:hover {background-color: yellow; font-size: 15px;}
       .dropdown-content-container3 .tagsOnlyContainer .checkboxContainer:hover .checkboxLabel {background-color: yellow; font-size: 15px;}
       .dropdown-content-container3 .addtag:hover {background-color: purple; font-size: 15px;}
       .dropdown-content-container3 .addSubmenu:hover {background-color: purple; font-size: 15px;}
       .dropdown-content-container3  a:hover {background-color: yellow; font-size: 15px;}
       .dropdown-content-container4 .tagsOnlyContainer .checkboxContainer:hover .checkboxLabel {background-color: yellow; font-size: 15px;}
       .dropdown-content-container4 .addtag:hover {background-color: purple; font-size: 15px;}
       .dropdown-content-container4 .addSubmenu:hover {background-color: purple; font-size: 15px;}
       .dropdown-content-container4  a:hover {background-color: yellow; font-size: 15px;}
       .dropdown-content-container5 .tagsOnlyContainer .checkboxContainer:hover .checkboxLabel {background-color: yellow; font-size: 15px;}
       .dropdown-content-container5 .addtag:hover {background-color: purple; font-size: 15px;}
       .dropdown-content-container5 .addSubmenu:hover {background-color: purple; font-size: 15px;}
       .dropdown-content-container5  a:hover {background-color: yellow; font-size: 15px;}
       /* show the dropdown menu on hover */
       .checkboxContainer:hover .turnIntoSubmenuDiv {position: absolute; display: inline; z-index: 2;}
       .dropdown1:hover .dropdown-contentNormal {position: absolute; display: inline; z-index: 2;}
       .dropdown1:hover .dropdown-contentRightEdge {position: absolute; display: inline; z-index: 2;}
       .dropdown2:hover .dropdownSubmenu2-contentNormal {position: absolute; display: inline; z-index: 2;}
       .dropdown2:hover .dropdownSubmenu2-contentRightEdge {position: absolute; display: inline; z-index: 2;}
       .dropdown2 .dropdown2:hover .dropdownSubmenu3-contentNormal {position: absolute; display: inline; z-index: 2;}
       .dropdown2 .dropdown2:hover .dropdownSubmenu3-contentRightEdge {position: absolute; display: inline; z-index: 2;}
       .dropdown2 .dropdown2 .dropdown2:hover .dropdownSubmenu4-contentNormal {position: absolute; display: inline; z-index: 2;}
       .dropdown2 .dropdown2 .dropdown2:hover .dropdownSubmenu4-contentRightEdge {position: absolute; display: inline; z-index: 2;}
       .dropdown2 .dropdown2 .dropdown2 .dropdown2:hover .dropdownSubmenu5-contentNormal {position: absolute; display: inline; z-index: 2;}
       .dropdown2 .dropdown2 .dropdown2 .dropdown2:hover .dropdownSubmenu5-contentRightEdge {position: absolute; display: inline; z-index: 2;}
       .dropdownButton:hover {background-color:yellow;}
       .submitbtnOff {margin-right: 80px; background-color: #ff0000; color: white; padding-left: 6px; text-align: center; opacity:0.2;
                   padding-right: 6px; padding-top: 2px; padding-bottom: 2px; font-size: 12px; border: none; border-radius: 8px;}
       .submitbtnOff:hover {background-color: #23045f; color: yellow;}
       .submitbtnOn {margin-right: 80px; background-color: #ff0000; color: white; padding-left: 6px; text-align: center; opacity:1;
                   padding-right: 6px; padding-top: 2px; padding-bottom: 2px; font-size: 12px; border: none; border-radius: 8px;}
       .submitbtnOn:hover {background-color: #23045f; color: yellow;}
       .exitbtnOn {margin-right: 80px; margin-top: 5px; background-color: #F4F4F4; color: #C1C2C2; padding-left: 6px; text-align: center; opacity:1;
                 padding-right: 6px; padding-top: 2px; padding-bottom: 2px; font-size: 12px; border:1px solid #DCDDDE; border-radius: 8px;}
       .exitbtnOn:hover {background-color: #A5A5A5; color: white;}
       .exitbtnOff {margin-right: 80px; margin-top: 5px; background-color: #F4F4F4; color: #C1C2C2; padding-left: 6px; text-align: center; opacity:0.6;
                 padding-right: 6px; padding-top: 2px; padding-bottom: 2px; font-size: 12px; border:1px solid #DCDDDE; border-radius: 8px;}
       .exitbtnOff:hover {background-color: #A5A5A5; color: white;}
       .addgroup {margin-left: 80px; background-color: #896dad; color: white; padding-top: 2px; text-align: center; position: relative;
                  padding-bottom: 2px; padding-left: 5px; padding-right: 5px; font-size: 12px; border: 1px; border-radius: 3px;}
       .addgroup:hover {background-color: #23045f; color: yellow;}
       .addtag {background-color: #552575; color: white; padding:2px; margin-bottom:5px; font-size: 12px; border: none; border-radius: 3px;}
       .addSubmenu {background-color: #3333cc; color: white; padding: 2px; margin-bottom:5px; font-size: 12px; border: none; border-radius: 3px;}
       .addtag:hover {background-color: #23045f; color: yellow;}      
       .addSubmenu:hover {background-color: #23045f; color: yellow;}      
       .stickyTop {background-color: white; position: fixed; top: 0; width:100%; z-index: 1;}
       .top-controls-container {display:flex; justify-content: space-between; align-items: center;}
       .exitButtonContainer {display:flex; flex-direction:column; align-items:center; position:relative; top:-1px;}
       .canvas-container {position:relative; width:100%; bottom:0px; left:0px;}
       .canvas-container canvas {position: absolute; top:0; left:0;}
       .everything {position:relative}
       .bottom-controls-container {background-color: #faf2ca; position: fixed; bottom: 0px; width: 100%; padding-bottom: 10px; z-index:1;}
       .btn-zoomin {background-color: #3a5f6b; color: white; text-align: center; font-size: 15px; width: 30px; border-radius: 8px;}
       .btn-zoomin:hover {background-color: #003333; color: white;}
       .btn-zoomout {background-color: #3a5f6b; color: white; text-align: center; font-size: 15px; width: 30px; border-radius: 8px;}
       .btn-zoomout:hover {background-color: #003333; color: white;}
       .btn-pageprev {background-color: #3a5f6b; color: white; text-align: center; font-size: 12px; padding-left:20px; padding-right:20px; border-radius: 3px;}
       .btn-pageprev:hover {background-color: #003333; color: white;}
       .btn-pagenext {background-color: #3a5f6b; color: white; text-align: center; font-size: 12px; padding-left:20px; padding-right:20px; border-radius: 3px;}
       .btn-pagenext:hover {background-color: #003333; color: white;}
       .makeComment {position:absolute; right:10px; background-color: #009999; color: black; padding-left: 6px;
                     padding-right: 6px; padding-top: 2px; padding-bottom: 2px; font-size: 12px; border: none; border-radius: 8px;}
       .makeComment:hover {background-color: #003333; color: white;}
       .makeHighlightOnly {position:relative: background-color: #F2F1A8, color:black; padding-left: 6px;
                     padding-right: 6px; padding-top: 2px; padding-bottom: 2px; font-size: 12px; border: none; border-radius: 8px;}
       .makeHighlightOnly:hover {background-color: #7B7A45; color: white;} 
       .commentForm {padding-left:5px; padding-right:10px; padding-bottom:5px; padding-top:15px; margin-right:10px; min-width:100px; min-height:50px; z-index:1; 
                     border-radius:3px; display:none; position: fixed; background:#efeed1; border:10px solid #4f4f3d; box-shadow: 0px 20px 20px 0px rgba(0,0,0,0.3);} 
       .commentForm textarea {min-height:10px; width:100%; font-family: Verdana, Tahoma, Arial, Helvetica, sans-serif; font-size:14px; overflow:scroll;
                              border:3px solid grey; background:#ddd; font-weight:bold; text-align:left; padding-left:10px; padding-top:10px; z-index:1}
       .commentForm textarea:focus {background-color:white; border:5px solid black;}
       .commentTagBtn {padding-left:5px; padding-right:5px; border: 3px solid black; border-radius:4px; background: rgba(0,0,0,0.5); color:white;}
       .commentTagBtn:hover {background:rgba(0,0,0,1)}
       .cancelOrFinishButtonsContainer {display:none; align-items:center; padding-top:20px; justify-content:space-between;} 
       .hiddenStorage {display: none;}
       .newCommentForm {padding-left:5px; padding-right:10px; padding-bottom:5px; padding-top:15px; margin-right:10px; min-width:300px; min-height:200px; 
                        display:none; position:fixed; background:#efeed1; border:10px solid #4f4f3d; box-shadow: 0px 20px 20px 0px rgba(0,0,0,0.3); z-index:1;}
       .newCommentForm textarea {width:100%; font-family: Verdana, Tahoma, Arial, Helvetica, sans-serif; font-size:14px; overflow:scroll;
                                 border:3px solid grey; background:#ddd; font-weight:bold; text-align:left; padding-left:10px; padding-top:10px; z-index:1}
       .newCommentForm textarea:focus {background-color:white; border:5px solid black;}
       .commentFinished {background-color:#1c4e87; color:white; text-align:center; font-size:14px; padding-left:5px; padding-right:5px; border:5px solid black; border-radius:3px; opacity:0.6;}
       .commentFinished:hover {opacity:1;}
       .commentCancel {background-color:red; color:black; text-align:center; font-size:14px; padding-left:5px; padding-right:5px; border:5px solid black; border-radius:3px; opacity:0.6;}
       .commentCancel:hover {color:white; opacity:1;}
       .newCommentFinished {background-color: #1c4e87; color:white; text-align:center; font-size:14px; padding-left:5px; padding-right:5px; border:5px solid black; border-radius:3px; opacity:0.6;}
       .newCommentFinished:hover {opacity:1;}
       .newCommentCancel {background-color:red; color:black; text-align:center; font-size:14px; padding-left:5px; padding-right:5px; border:5px solid black; border-radius:3px; opacity:0.6;}
       .newCommentCancel:hover {color:white; opacity:1;}
       ::placeholder {color:grey; opacity:0.5; font-style:italic; font-size:14px; text-align:center}
       .tagSummaryBtn {position:absolute; left:1px; top:1px; width:30px; height:30px; z-index:1; padding:0; border:0; border-radius:12px; 
                       background: radial-gradient(circle at center, #142D5B99 0%, #142D5B4D 15%, #0000001A 50%, #00000005 100%)} 
       /*transparency: 60%, 30%, 10%, 2%*/
       /*https://developer.mozilla.org/en-US/docs/Web/CSS/gradient/radial-gradient() */
       /*https://gist.github.com/lopspower/03fb1cc0ac9f32ef38f4 */
       .tagSummaryBtn:hover {border-radius:11px; background: radial-gradient(circle at center, #142D5B, #00000005)}
       .newCommentHighlight    {text-shadow: 3px 0px 3px #d9b3ff,     -3px 0px 3px #d9b3ff,     6px 0px 6px #d9b3ff,     -6px 0px 6px #d9b3ff;}
       .storedCommentHighlight {text-shadow: 3px 0px 3px #ccffff,     -3px 0px 3px #ccffff,     6px 0px 6px #ccffff,     -6px 0px 6px #ccffff;}
       .highlightOnly          {text-shadow: 3px 0px 3px #ffdab3,     -3px 0px 3px #ffdab3,     6px 0px 6px #ffdab3,     -6px 0px 6px #ffdab3;}
       .statusBarMode {font-color:yellow; font-size:16px; font-weight:bold; background-color:red; padding-left:5px; padding-right:5px; padding-top:2px; padding-bottom:2px;}
       .notBusy {font-size: 12px; text-align:center;}
       .busy {display:none; width:50%; font-size:16px; text-align:center; color:red; font-weight:bold; font-size:18px; background-color:#FFFF00;
              padding-left:5px; padding-right:5px; padding-top:2px; padding-bottom:2px;}
       .commentsOnThesePages {left:70%; top:50%; padding-left:5px; padding-right:10px; padding-bottom:5px; padding-top:15px; margin-right:10px; min-width:100px; min-height:50px; z-index:0; 
              border-radius:3px; display:block; position: fixed; background:#efeed1; border:10px solid #4f4f3d; box-shadow: 0px 20px 20px 0px rgba(0,0,0,0.3);} 
    </style>
    <script>
    </script>
  </head>
  <body>
     <!-- ------------------------------------------------------------------------ -->
     <!-- ----------------------------- B O D Y ---------------------------------- -->
     <!-- ------------------------------------------------------------------------ -->
     <div id="scrollbar-helper"></div>
     <div class="everything" style="width: 100%">
        <div class="hiddenStorage" id="hiddenStorage"><?!= hiddenStorage; ?></div>
        <div class="hiddenStorage" id="highlightStorage"></div> 
        <div class="hiddenStorage" id="newLevel1GroupDivTemplate">
             <button class="dropdown-header" id="buttonINSERTtagId">INSERTdisplayTagName</button>
             <div class="dropdown-contentNormal" id="dropdownContentINSERTtagId">
                  <div class="dropdown-content-container1">
                        <div class="tagsOnlyContainer" id="tagsOnlyContainerForINSERTtagId">
                             <div class="checkboxContainerWithoutConversion" id="checkboxContainerINSERTtagId">
                                 <div class="checkboxLabel" id="checkboxLabelINSERTtagId">
                                      <input type="checkbox" class="checkboxForTag" id="checkboxINSERTtagId" name="INSERTfullTagName" data-mode="pdf" onchange="colorButton(this.id)">
                                      <label for="checkboxINSERTtagId" style="color:INSERTcolor; font-weight:INSERTweight;">INSERTdisplayTagName</label>
                                 </div>
                             </div>
                        </div>
                        <br><hr><br>
                        <div><button class="addtag" id="addtagINSERTtagId">Add New Tag</button></div>
                        <div><button class="addSubmenu" id="addSubmenuINSERTtagId">Add Tag Sub-menu</button></div>
                  </div>
             </div>
        </div>
        <div class="hiddenStorage" id="newLevel2GroupDivTemplate">
             <div class="dropdownButton"><button class="dropdown-header" id="buttonINSERTtagId">INSERTdisplayTagName</button></div>
             <div class="dropdownSubmenu2-contentNormal" id="dropdownContentINSERTtagId">
                  <div class="dropdown-content-container2">
                        <div class="tagsOnlyContainer" id="tagsOnlyContainerForINSERTtagId">
                             <div class="checkboxContainerWithConversion" id="checkboxContainerINSERTtagId">
                                 <div class="checkboxLabel" id="checkboxLabelINSERTtagId">
                                      <input type="checkbox" class="checkboxForTag" id="checkboxINSERTtagId" name="INSERTfullTagName" data-mode="pdf" onchange="colorButton(this.id)">
                                      <label for="checkboxINSERTtagId" style="color:INSERTcolor; font-weight:INSERTweight;">INSERTdisplayTagName</label>
                                 </div>
                                 <div id="turnIntoSubmenuDivINSERTtagId" class="turnIntoSubmenuDiv">
                                     <button class="turnIntoSubmenuBtn" id="turnIntoSubmenuBtnINSERTtagId">📁</button>
                                 </div>
                             </div>
                        </div>
                        <br><hr><br>
                        <div><button class="addtag" id="addtagINSERTtagId">Add New Tag</button></div>
                        <div><button class="addSubmenu" id="addSubmenuINSERTtagId">Add Tag Sub-menu</button></div>
                  </div>
             </div>
        </div>
        <div class="hiddenStorage" id="newLevel3GroupDivTemplate">
             <div class="dropdownButton"><button class="dropdown-header" id="buttonINSERTtagId">INSERTdisplayTagName</button></div>
             <div class="dropdownSubmenu3-contentNormal" id="dropdownContentINSERTtagId">
                  <div class="dropdown-content-container3">
                        <div class="tagsOnlyContainer" id="tagsOnlyContainerForINSERTtagId">
                             <div class="checkboxContainerWithConversion" id="checkboxContainerINSERTtagId">
                                 <div class="checkboxLabel" id="checkboxLabelINSERTtagId">
                                      <input type="checkbox" class="checkboxForTag" id="checkboxINSERTtagId" name="INSERTfullTagName" data-mode="pdf" onchange="colorButton(this.id)">
                                      <label for="checkboxINSERTtagId" style="color:INSERTcolor; font-weight:INSERTweight;">INSERTdisplayTagName</label>
                                 </div>
                                 <div id="turnIntoSubmenuDivINSERTtagId" class="turnIntoSubmenuDiv">
                                     <button class="turnIntoSubmenuBtn" id="turnIntoSubmenuBtnINSERTtagId">📁</button>
                                 </div>
                             </div>
                        </div>
                        <br><hr><br>
                        <div><button class="addtag" id="addtagINSERTtagId">Add New Tag</button></div>
                        <div><button class="addSubmenu" id="addSubmenuINSERTtagId">Add Tag Sub-menu</button></div>
                  </div>
             </div>
        </div>
        <div class="hiddenStorage" id="newLevel4GroupDivTemplate">
             <div class="dropdownButton"><button class="dropdown-header" id="buttonINSERTtagId">INSERTdisplayTagName</button></div>
             <div class="dropdownSubmenu4-contentNormal" id="dropdownContentINSERTtagId">
                  <div class="dropdown-content-container4">
                        <div class="tagsOnlyContainer" id="tagsOnlyContainerForINSERTtagId">
                             <div class="checkboxContainerWithConversion" id="checkboxContainerINSERTtagId">
                                 <div class="checkboxLabel" id="checkboxLabelINSERTtagId">
                                      <input type="checkbox" class="checkboxForTag" id="checkboxINSERTtagId" name="INSERTfullTagName" data-mode="pdf" onchange="colorButton(this.id)">
                                      <label for="checkboxINSERTtagId" style="color:INSERTcolor; font-weight:INSERTweight;">INSERTdisplayTagName</label>
                                 </div>
                                 <div id="turnIntoSubmenuDivINSERTtagId" class="turnIntoSubmenuDiv">
                                     <button class="turnIntoSubmenuBtn" id="turnIntoSubmenuBtnINSERTtagId">📁</button>
                                 </div>
                             </div>
                        </div>
                        <br><hr><br>
                        <div><button class="addtag" id="addtagINSERTtagId">Add New Tag</button></div>
                        <div><button class="addSubmenu" id="addSubmenuINSERTtagId">Add Tag Sub-menu</button></div>
                  </div>
             </div>
        </div>
        <div class="hiddenStorage" id="newLevel5GroupDivTemplate">
             <div class="dropdownButton"><button class="dropdown-header" id="buttonINSERTtagId">INSERTdisplayTagName</button></div>
             <div class="dropdownSubmenu5-contentNormal" id="dropdownContentINSERTtagId">
                  <div class="dropdown-content-container5">
                        <div class="tagsOnlyContainer" id="tagsOnlyContainerForINSERTtagId">
                             <div class="checkboxContainerWithoutConversion" id="checkboxContainerINSERTtagId">
                                  <div class="checkboxLabel" id="checkboxLabelINSERTtagId">
                                       <input type="checkbox" class="checkboxForTag" id="checkboxINSERTtagId" name="INSERTfullTagName" data-mode="pdf" onchange="colorButton(this.id)">
                                       <label for="checkboxINSERTtagId" style="color:INSERTcolor; font-weight:INSERTweight;">INSERTdisplayTagName</label>
                                  </div>
                             </div>
                        </div>
                        <br><hr><br>
                        <div><button class="addtag" id="addtagINSERTtagId">Add New Tag</button></div>
                  </div>
             </div>
        </div>
        <!-- ==================================================================================================================== -->
        <!-- ======================================== the screen layout ========================================================= -->
        <!-- ==================================================================================================================== -->
        <!-- ----------------------------------------- recorded comment summary form -------------------------------------------------------->
        <div class="commentForm" data-hasEntered="" onMouseEnter="userHasEntered()" onMouseLeave="shouldCommentFormClose()">
            <div style="text-align:center;"><span><em>(You can drag this box out of your way)</em></span></div><br><br>
            <div>
               <div style="text-align:center"><span style="font-size:14px;"><strong>The quote from the paper is below (editable)</strong></span></div>
               <textarea id="recordedQuote"></textarea>
               <br><br>
            </div>
            <div style="display:block">
               <div style="text-align:center"><span style="font-size:14px;"><strong>Supplemental User Note (optional)</strong></span><br></div>
               <textarea id="recordedUsernote"></textarea>
               <br><br>
            </div>
            <div style="text-align:center;"><span style="font-size:14px;"><strong>Tags assigned to this comment:</strong></span><br></div>
            <div class="searchTagSpanContainer" style="font-size:14px; padding-bottom:10px;">
                <!-- individual search tags will be listed as divs under here -->
            </div> 
            <div class="commentTagBtnContainer">
                <button class="commentTagBtn" id="editCommentcommentId" onclick="editThisComment(this.id)">Edit Comment and/or Associated Tags</button>
            </div>
            <div class="cancelOrFinishButtonsContainer">  <!-- style="display:flex;" -->
                <button class="commentCancel" onclick="closeComment()">Cancel & Exit Comment Editor</button>
                &nbsp
                <button class="commentFinished" id="changeTagscommentId" onclick="moveCommentInfoIntoStorage(this.id)">Finished Editing Comment</button>
            </div>
        </div>
        <!-- ----------------------------------------- new comment form -------------------------------------------------------->
        <div class="newCommentForm">
            <div style="display:block; padding-top:20px">
               <div style="text-align:center">
                  <span style="font-size:14px;">The selected quote is below <i>(You may edit the quote, or delete if only the user comment is desired)</i></span>
                  <br>
                  <span style="font-size:10px;">Grab yellow background to drag/move box</span>
                  <br>
               </div>
               <textarea id="newCommentQuote" name="newCommentQuote"></textarea>
            </div>
            <br><br>
            <div style="display:block">
               <div style="text-align:center">
                  <span style="font-size:14px;">Supplemental User Note (optional)</span> 
                  <br>
               </div>
               <textarea id="newCommentUsernote" placeholder="(additional thoughts or comments to supplement the quote)" name="userNewComment"></textarea>
             </div>
             <div style="display:flex;justify-content:space-between;align-items:center; padding-top:20px">
                 <button class="newCommentCancel" onclick="closeNewComment(true)">Cancel & Exit Comment Editor</button>
                 &nbsp
                 <button class="newCommentFinished" onclick="moveNewCommentInfoIntoStorage()">Finished w/ Comment</button>
             </div>
             <div style="display:none" id="newCommentCoords"></div>
             <div style="display:none" id="newCommentId"></div>
        </div>
        <!---------------------- top of visible screen, where the new category button and the process changes buttons are presented, with the tag edit menu following -->
        <div class="stickyTop">
             <div class="top-controls-container">
                  <button class="addgroup" onclick="getNewGroupName()">Add New CATEGORY</button>
                  <div id="statusBar" data-fileCommentId="file" data-fileCommentId='pdf'>
                      <div class="notBusy">To assign tags to this <span class="statusBarMode">WHOLE PAPER</span>: hover over below, select from drop-down list.</div>
                      <div class="busy">BUSY</div>
                  </div>
                  <div class="exitButtonContainer">
                      <button class="submitbtnOff" onclick="processChanges()">SAVE CHANGES and EXIT</button>
                      <button class="exitbtnOn" onclick="exitCheck()">exit without saving changes</button>
                  </div>
                      
             </div><br>
             <div class="tagEditMenu">
                  <!-- a list of div groups; each div grouping construct a button representing a level 1 tag category, with a drop-down menu listing the sub-tags for that 
                       category, will be listed below, constructed from the templates provided in the template section above. -->
             </div>
        </div>
        <div class="canvas-container"> 
             <!-- make a vertical strip to the left of the canvas that will hold comments from the paper -->
             <canvas id="the-canvas" style="border:1px solid black; direction:ltr"></canvas>
             <div class="textLayer"></div>
        </div>
        <div class="bottom-controls-container">
             <button type="button" class="btn-zoomout" onclick="zoomout()"><span>-</span></button>
             &nbsp; &nbsp;zoom&nbsp; &nbsp;
             <button type="button" class="btn-zoomin" onclick="zoomin()"><span>+</span></button>
             &nbsp; &nbsp;&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; &nbsp; &nbsp;&nbsp; &nbsp;
             <button type="button" class="btn-pageprev" onclick="onPrevPage()"><span>&#60&#60Prev</span></button>
             <span style="font-size:12px">Page <input id="page_num" min="1" value="1" type="number" style="font-size:12px" size="5"/> of <span id="page_count" style="font-size:12px"></span></span>
             <button type="button" class="btn-pagenext" onclick="onNextPage()"><span>Next&#62&#62</span></button>
             &nbsp; &nbsp;&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; &nbsp;
             <button class="makeHighlightOnly" onclick="makeHighlightOnly()">Create Temporary Highlight</button>
             &nbsp; &nbsp;&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; &nbsp;
             <button class="makeComment" onclick="displayNewCommentForm()">Create Comment</button> 
        </div>
        <!-- little movable pop-up that shows what pages comments are on -->
        <div class="commentsOnThesePages">
             <div style="text-align:center;"><span><em>(You can drag this box out of your way)</em></span></div>
             <div style="text-align:center;"><span>Comments are located on the following pages:</span></div>
             <div style="text-align:center;"><span id="commentPages"></span></div>
        </div>
     </div>
     <!-- ==================================================================================================================== -->
     <!-- ================================================== SCRIPTS ========================================================= -->
     <!-- ==================================================================================================================== -->
     <script>       

       ///////////////////////////////////////////////////////////////////////////////////////
       /////////////////////////////////////  exitCheck //////////////////////////////////////
       function exitCheck(){
          var storedInfo = JSON.parse($("#hiddenStorage")[0].innerText);
          var unsavedChanges = false;
          if (storedInfo['pdf'] && storedInfo.pdf.tagEdited){unsavedChanges = true;}
          var commentIdList = Object.keys(storedInfo);
          for (let commentId of commentIdList){if (storedInfo[commentId].edited){unsavedChanges = true;}}
          var askText = 'You have made changes without hitting the "Process Changes" button.  Do you want these changes to be processed?\n'+
                        '   "OK"     = "Yes, please proceed in incorporating the changes into the permanent database!"\n'+
                        '   "Cancel" = "Nah, I was just messing around! Ignore changes made, do NOT incorporate them into the database!")';
          if (unsavedChanges){if (confirm(askText)){processChanges();}} 
          google.script.host.close();
          google.script.host.editor.focus();
       }
       /////////////////////////////////////  exitCheck //////////////////////////////////////
       ///////////////////////////////////////////////////////////////////////////////////////
     
       /////////////////////////////////////////////////////////////////////////////////////////////////
       /////////////////////////////////////// getSortIndices //////////////////////////////////////////
       function getSortIndices(sortThis){
         var indices = Array.from(Array(sortThis.length).keys()).sort((a,b) => sortThis[a]<sortThis[b] ? -1 : (sortThis[b]<sortThis[a])|0);
         return indices;
       }
       /////////////////////////////////////////////////////////////////////////////////////////////////

       /////////////////////////////////////////////////////////////////////////////////////////////////
       /////////////////////////////////////  generateTagEditMenu //////////////////////////////////////
       function generateTagEditMenu(){
          // is only called when the tags have changed or the menu needs to be initialized. The code below creates the menu using
          // all the tags mentioned in the hidden storage.  The checkboxes are set by a different program, setTagMenuCheckboxes
          var storedInfo = JSON.parse($("#hiddenStorage")[0].innerText);
          var tagLibrary = storedInfo.tagLibrary;
          var tagIdList = tagLibrary.tagIdList;
          // ############  LEVELS 1 through 6 ########
          for (let level=1; level<=6; level++){
              var thisIdList = tagIdList.filter(z => tagLibrary[z].level == level);
              var nameList = [];
              if (thisIdList && thisIdList.length > 0){
                  // get the corrsponding tag name so that the id's can be arranged in such a way that their corresponding tag names will be alphabetized
                  nameList = thisIdList.map(z => tagLibrary[z].displayName).sort();
                  var sortedIndices = getSortIndices(nameList);
                  var thisIdList = sortedIndices.map(z => thisIdList[z]);
              } else {thisIdList = [];}
              for (let j in thisIdList){if (tagLibrary[thisIdList[j]].isSubMenu){createTagGroupDiv(thisIdList[j])} else {createTagCheckboxDiv(thisIdList[j]);}}
          }
       }
       /////////////////////////////////////  generateTagEditMenu //////////////////////////////////////
       /////////////////////////////////////////////////////////////////////////////////////////////////
          
       ///////////////////////////////////////////////////////////////////////////////////////////////
       ///////////////////////////////////////  createTagGroupDiv //////////////////////////////////////
       function createTagGroupDiv(thisId){
          // generates a bare tag group "div" -- this function is called by generateTagEditMenu to help build that one piece of the menu
          var storedInfo = JSON.parse($("#hiddenStorage")[0].innerText);
          var tagLibrary = storedInfo.tagLibrary;
          var maxTagLevels = storedInfo.maxTagLevels;
          var tagGroupDivHtml = $("#newLevel" + tagLibrary[thisId].level + "GroupDivTemplate")[0].innerHTML;
          var tagGroupDivHtml = tagGroupDivHtml.replace(/INSERTfullTagName/g, tagLibrary[thisId].fullName);
          var tagGroupDivHtml = tagGroupDivHtml.replace(/INSERTdisplayTagName/g, tagLibrary[thisId].displayName);
          var tagGroupDivHtml = tagGroupDivHtml.replace(/INSERTtagId/g, thisId);
          var tagGroupDivHtml = tagGroupDivHtml.replace(/INSERTcolor/g, "#3e8e41");
          var tagGroupDivHtml = tagGroupDivHtml.replace(/INSERTweight/g, "bold");
          var tagGroupDiv = document.createElement("div");
          if (tagLibrary[thisId].level == 1){tagGroupDiv.className = "dropdown1";} else {tagGroupDiv.className = "dropdown2";}
          tagGroupDiv.id = 'groupDiv'+thisId;
          tagGroupDiv.innerHTML = tagGroupDivHtml;
          // Now insert this group into the actual HTML:
          if (tagLibrary[thisId].level == 1){
              $(".tagEditMenu")[0].appendChild(tagGroupDiv);
          } else {
              var tagsOnlyContainer = document.getElementById("tagsOnlyContainerFor" + tagLibrary[thisId].parentTagId);
              // if the name of this new tag group already appears as a tag among the list in which it is to appear under the parent Level, then 
              // instead of adding this new tag at the bottom of the list, turn that tag (a check box) into this new div by replacing the checkbox with this div
              var existingTag = document.getElementById("checkboxContainer" + thisId);
              if (existingTag && existingTag !== null){
                  // found a match!  replace this elemnent with the group div.
                  // get the value of the echekbox -- if it is already checked, then check the first box in the list of the new submenu, and also 
                  // give it the purple color to indicate a selected element within the submenu
                  var checkbox = document.getElementById("checkbox" + thisId);
                  var isItChecked = false;
                  if (checkbox && checkbox !== null) {isItChecked = checkbox.checked;}
                  existingTag.innerHTML = tagGroupDivHtml;
                  existingTag.id = 'groupDiv' + thisId;
                  existingTag.className = "dropdown2";
                  if (isItChecked){
                     var checkbox = document.getElementById("checkbox" + thisId);
                     checkbox.checked = true;
                     // find the button corresponding to this grouping of tags
                     var parentElmt = document.getElementById("button"+thisId);
                     parentElmt.className = 'dropdown-headerFlagged';
                  }
              } else {
                  // make sure that no other existing tag has the same name:
                  tagsOnlyContainer.appendChild(tagGroupDiv);
              }
          }
          // If this tag group was for a level 1 menu, figure out where the button landed.  If too close to the right edge of the screen, have all 
          // the submenus fold out to the left of the button instead of to the right of it. 
          var dropdown = document.getElementById("groupDiv"+thisId);
          var offsetBetweenSubmenus = 40; // px
          var padding = 20; // px
          var submenuWidth = 200; // px
          if (tagLibrary[thisId].level == 1){
              var rect = dropdown.getBoundingClientRect();
              var remainingRightMargin = window.innerWidth - scrollbarWidth - rect.left;
              var requiredSpace = (maxTagLevels - 2)*offsetBetweenSubmenus + 2*padding + submenuWidth;
              if (remainingRightMargin < requiredSpace && rect.right <= window.innerWidth - scrollbarWidth){
                  // not enough room left for submenus to fold out to the right side of the main button, so have everything fold out to the left side instead
                  var dropdownContent = document.getElementById("dropdownContent"+thisId);
                  dropdownContent.className = "dropdown-contentRightEdge";
              }
          } else {
              // check that the associated level-1  is not converted over to a right edge dropdown format:
              var level1Id = tagLibrary[thisId].level1ParentId;
              var level1DropdownContent = document.getElementById("dropdownContent"+level1Id);
              if (level1DropdownContent.className == "dropdown-contentRightEdge"){
                  var dropdownContent = document.getElementById("dropdownContent"+thisId);
                  dropdownContent.className = "dropdownSubmenu" + tagLibrary[thisId].level + "-contentRightEdge";
              }
          }
          // add the event listener to allow new sub-tags to be created for this category:
          var addtag = document.getElementById("addtag"+thisId);
          addtag.addEventListener('click', function(){getNewTagName(thisId);});          
          if (tagLibrary[thisId].level  < maxTagLevels-1){
              // and to allow addition of new sub-categories under this category:
              var addtag = document.getElementById("addSubmenu"+thisId);
              addtag.addEventListener('click', function(){getSubmenu(thisId);});
          }
       }
       ///////////////////////////////////////  createTagGroupDiv //////////////////////////////////////
       ///////////////////////////////////////////////////////////////////////////////////////////////
       
       /////////////////////////////////////////////////////////////////////////////////////////////////  
       //////////////////////////////////////  createTagCheckboxDiv ////////////////////////////////////
       function createTagCheckboxDiv(thisId){
          var storedInfo = JSON.parse($("#hiddenStorage")[0].innerText);
          var tagLibrary = storedInfo.tagLibrary;
          var maxTagLevels = storedInfo.maxTagLevels;
          if (tagLibrary[thisId].level < maxTagLevels){var htmlName = ".checkboxContainerWithConversion";} else {var htmlName = ".checkboxContainerWithoutConversion";}
          var checkboxDivHtml=$(htmlName)[0].innerHTML;
          var checkboxDivHtml = checkboxDivHtml.replace(/INSERTdisplayTagName/g, tagLibrary[thisId].displayName);
          var checkboxDivHtml = checkboxDivHtml.replace(/INSERTfullTagName/g, tagLibrary[thisId].fullName);
          var checkboxDivHtml = checkboxDivHtml.replace(/INSERTtagId/g, thisId);
          var checkboxDivHtml = checkboxDivHtml.replace(/INSERTcolor/g, "black");
          var checkboxDivHtml = checkboxDivHtml.replace(/INSERTweight/g, "normal");
          var checkboxDiv = document.createElement("div");
          checkboxDiv.className = "checkboxContainer";
          checkboxDiv.id = "checkboxContainer" + thisId;
          checkboxDiv.innerHTML = checkboxDivHtml;
          // Now insert this checkbox at the bottom of the list of checkboxes in this group of tags:
          var tagsOnlyContainer = document.getElementById("tagsOnlyContainerFor" + tagLibrary[thisId].parentTagId);
          tagsOnlyContainer.appendChild(checkboxDiv);
          //---------------------------------------------------------------------------------------------
          // and to allow addition of new sub-categories under this category:
          if (tagLibrary[thisId].level < maxTagLevels){
              var convertToSubmenu = document.getElementById("turnIntoSubmenuBtn" + thisId);
              if (convertToSubmenu && convertToSubmenu !== null){convertToSubmenu.addEventListener('click', function(){createTagGroupDiv(thisId);});}
          }
       }               
       //////////////////////////////////////  createTagCheckboxDiv ////////////////////////////////////
       /////////////////////////////////////////////////////////////////////////////////////////////////

       ///////////////////////////////////////////////////////////////////////////////////////////////
       /////////////////////////////////////  fillOutCommentPages ////////////////////////////////////
       function fillOutCommentPages(){
          var storedInfo = JSON.parse($("#hiddenStorage")[0].innerText);
          var commentsOnThesePages = [];
          for (let commentId of storedInfo.commentIdList){
              for (let coord of storedInfo[commentId].coords){commentsOnThesePages.push(coord.p);}
          }
          var commentsOnThesePages = ([... new Set(commentsOnThesePages)]).sort();
          document.getElementById('commentPages').textContent = commentsOnThesePages.join(", ");
       }
       ///////////////////////////////////////////////////////////////////////////////////////////////

       ////////////////////////////////////////////////////////////////////////////////////////////////
       ///////////////////////////////////////  userHasEntered ////////////////////////////////////////
       function userHasEntered(){$(".commentForm")[0].setAttribute("data-hasEntered","yes");}
       ////////////////////////////////////////////////////////////////////////////////////////////////
       
       ////////////////////////////////////////////////////////////////////////////////////////
       ///////////////////////////////  shouldCommentFormClose ////////////////////////////////
       function shouldCommentFormClose(){
          // close the comment tag summary box if ... 
          //   (1) the comment tag summary box is open and the tag edit menu is not opened for the comment but rather for the pdf
          //   (2) the comment tag summary box never was entered by the mouse and N seconds have passed by
          // THIS FUNCTION performs (1).   The condition (2) is tested by the html 
          if ($("#statusBar")[0].getAttribute("data-fileComment") == "file"){closeComment();}
       }
       ///////////////////////////////  shouldCommentFormClose ////////////////////////////////
       ////////////////////////////////////////////////////////////////////////////////////////
       
       /////////////////////////////////////////////////////////////////////////////////////////////////
       ///////////////////////////////////////  editThisComment ////////////////////////////////////////
       function editThisComment(commentIdParam){
          var commentId = commentIdParam.replace(/^editComment/,"");
          // ============ make the "edit this comment" button disappear and replace with the "cancel edits" and "finished editing" buttons
          $(".commentTagBtnContainer")[0].style.display = "none";
          $(".cancelOrFinishButtonsContainer")[0].style.display = "flex";
          // =========== install the tag details for this comment in the tag edit menu along the top
          // make the comment-specific tags menu return back to that of the pdf file when the mouse leaves the menu
          // temporarily replace the checkbox answers of the pdf fiole with that of the comment or "newcomment" at hand now:
          setTagMenuCheckboxes(commentId);
          // turn off all of the buttons that would add confusion, like the "create comment" and "process changes" buttons
          turnOffButtons();
       }
       ///////////////////////////////////////  editThisComment ////////////////////////////////////////
       /////////////////////////////////////////////////////////////////////////////////////////////////
              
       /////////////////////////////////////////////////////////////////////////////////////////
       //////////////////////////////////  displayCommentForm //////////////////////////////////
       function displayCommentForm(idParam){
          // This code displays the tag summary for a comment, on mouseover of a comment.  The same "div" is used as a container to hold the summary
          // information for all comments, with the contents replaced with those relevant to the specific comment being shown. The tag summary includes
          // a button to bring up more detailed info on the tags for that comment and to allow for editing. When that button is pressed, the large tag edit
          // menu displayed at the top for the pdf file is replaced (well, everything is actually retained and it is the checkmarks themselves that are
          // replaced) with the information relevant to the comment itself, and the user may add or remove tags (or add new tag options) as desired. 
          var storedInfo = JSON.parse($("#hiddenStorage")[0].innerText);
          var hidePopupAfterThisManySeconds = storedInfo['hidePopupAfterThisManySeconds'];
          $(".commentForm")[0].setAttribute("data-hasEntered","");
          var commentId = idParam.replace(/^tagSummaryHover/,"").trim();
          // need to insert the comment id
          $(".commentTagBtn")[0].setAttribute("id", "editComment" + commentId);
          $(".commentFinished")[0].setAttribute("id", "changeTags" + commentId);
          var storedInfo = JSON.parse($("#hiddenStorage")[0].innerText);
          var fractX1 = storedInfo[commentId].coords[0].x1;
          var fractY1  = storedInfo[commentId].coords[0].y1;
          var nLoc = storedInfo[commentId].coords.length;
          var fractX2 = storedInfo[commentId].coords[nLoc-1].x2;
          var fractY2  = storedInfo[commentId].coords[nLoc-1].y2;
          var screen = fractionToScreen({"x1":fractX1, "y1":fractY1, "x2":fractX2, "y2":fractY2});
          // convert to fractions of the entire screen (rather than of the canvas):
          var searchTagNameList = storedInfo[commentId].tagNameList;
          var commentForm = document.querySelector(".commentForm");
          $(".commentForm")[0].style.removeProperty("left");
          $(".commentForm")[0].style.removeProperty("right");
          $(".commentForm")[0].style.removeProperty("top");
          $(".commentForm")[0].style.removeProperty("bottom");
          // clear out any previous entries relevant to a different comment that was being viewed earlier
          $("#recordedQuote")[0].value = null;
          $("#recordedUsernote")[0].value = null;
          // also clear out any previous content under the searchTagSpanContainer div
          $(".searchTagSpanContainer")[0].innerHTML = '';
          // if the comment is in the upper left quadrant then fix the summary box upper left corner to be at x=0.5 and y=line that comment is on.
          // if                       lower left                                   lower left                 x=0.5     
          // if                       upper right                                  upper right                x=0.5     
          // if                       lower right                                  lower right                x=0.5  
          // temporarily hide the buttons that could cause confusion such as the submittion button, the make comment button, paging forward/backward:
          // retrieve the information stored for this comment so that the popup can be made in real time
          if (storedInfo[commentId].quote != ""){$("#recordedQuote")[0].value = storedInfo[commentId].quote;}
          if (storedInfo[commentId].usernote != ""){$("#recordedUsernote")[0].value = storedInfo[commentId].usernote;}
          for (let i=0; i<searchTagNameList.length; i++){
              var div = document.createElement("div");
              div.innerHTML = searchTagNameList[i];
              $(".searchTagSpanContainer")[0].appendChild(div);
          } 
          // make sure the cancel and finish buttons are hidden, and that the one button to ask if comment editing is desired is displayed instead          
          $(".cancelOrFinishButtonsContainer")[0].style.display = "none";
          $(".commentTagBtnContainer")[0].style.display = "block;"
          // now reveal this otherwise hidden div
          $(".commentForm")[0].style.display = "block";
          var formRect = $(".commentForm")[0].getBoundingClientRect();
          var formWidth = formRect.width;
          var formHeight = formRect.height;
          var canvasBorders = canvas.getBoundingClientRect();
          var bottomControls = document.querySelector(".bottom-controls-container");
          var bottomRect = bottomControls.getBoundingClientRect();
          // position the form so that it does not get all smooshed up in the skinny margin if the pdf is taking up most of the space 
          if ((window.innerWidth - scrollbarWidth - canvasBorders.right) < formRect.width){
              $(".commentForm")[0].style.left = (window.innerWidth-formRect.width-5) + 'px';
          } else {
              $(".commentForm")[0].style.left = canvasBorders.right + 'px';
          }
          if ((window.innerHeight-bottomRect.height-screen.y1) >= formRect.height){
              $(".commentForm")[0].style.top = screen.y1 + 'px';
          } else {
              $(".commentForm")[0].style.top = (window.innerHeight-formRect.height-bottomRect.height) + 'px';
              // would be more straightforward to make this restriction on .bottom, but I found that when I set .bottom to a value, the pop up box is 
              // no longer able to be dragged/moved in the vertical direction. 
          }
          // Start the timer and if the user has not entered the comment summary box within "hideAfter" seconds (we will know if the user has entered the
          // comment summary box because the "data-hasEntered" will be non-null if the user entered), then hide the comment summary box. 
          hoverOverIcon(hidePopupAfterThisManySeconds, commentId);
       }
       //////////////////////////////////////  displayCommentForm ///////////////////////////////////////
       //////////////////////////////////////////////////////////////////////////////////////////////////   
              
       ///////////////////////////////////////////////////////////////////////////////////////////////
       ///////////////////////////////////// generateIdNumber ////////////////////////////////////////
       function generateIdNumber(preface, nDecimals, doNotDuplicateWithThisList){
          // generate a unique ID for this new comment that is an 8-decimal hex value:
          var randomId;
          while ( (!(randomId)) || randomId===null || doNotDuplicateWithThisList.indexOf(randomId) != -1){
              let n = (Math.random() * 0xfffff * 1000000).toString(16);
              randomId = '' + n.slice(0, nDecimals);
          }     
          return preface + randomId;
       }
       ///////////////////////////////////////////////////////////////////////////////////////////////
              
       /////////////////////////////////////////////////////////////////////////////////////////////////////
       /////////////////////////////////////  displayNewCommentForm ////////////////////////////////////////
       function displayNewCommentForm() {
          // SEQUENCE OF EVENTS: 
          //  (1) the user highlights some text where they want an anchored comment to appear
          //  (2) The user clicks on "Create Comment" button at the lower right corner
          //  (3) The selected area is highlighted with the "new comment" color. 
          //  (3) a "new comment form" pops up that shows the quote from the selected sentences of the pdf, a text box where additional
          //      notes can be added, and the large tag menu running along the top changes to be applicable for that of the new comment, 
          //      allowing the user to categorize the comment with a selection of tags.  At least 1 tag must be selected. 
          //  (4) The user clicks either "cancel" or "Finished" 
          //  (5) If "cancel", the highlight disappears and the new comment form disappears and the top tag menu reverts back to that of the pdf
          //      If "finished", the new comment form disappears, the top menu reverts back to that of the pdf.  The comment will remain highlighted
          //      with the "new comment" color until the "process changes" button is selected. 
          //  (6) A little fuzzy "ball" appears at the beginning of the comment, where the mouse can pass over and bring up the comment tag summary box later. 
          var storedInfo = JSON.parse($("#hiddenStorage")[0].innerText);
          var tmp = getSelectedTextArea();
          if (tmp == "error"){return;}
          var tmp = JSON.parse(tmp);
          var screenRects = tmp.screenRects;
          var canvasRects = tmp.canvasRects;
          var fractRects = tmp.fractRects;
          var coords = tmp.coords;
          var selectedText = tmp.selectedText;
          // generate a unique ID for this new comment that is an 8-decimal hex value:
          var commentId = generateIdNumber('c',8,storedInfo.commentIdList);
          // set up a place-holder for the comment information within storedInfo
          storedInfo[commentId] = {};
          $("#hiddenStorage")[0].innerText = JSON.stringify(storedInfo);
          applyHighlight(fractRects, newCommentColor);
          //store the highlight information temporarily, in case the user wishes to zoom in/out during the comment editing
          try {var highlightStorage = JSON.parse($("#highlightStorage")[0].innerHTML);} catch(e){var highlightStorage = [];}
          highlightStorage.push({"id":commentId, "p":pageNum, "coords":coords});
          $("#highlightStorage")[0].innerHTML = JSON.stringify(highlightStorage);
          // Now that the text has been selected and bounding coordinates on the canvas determined, go to next step of putting up a prompt
          // to ask user if any additional user-inputted comments are desired to accompany the quote.  Or if the quote is not desired.
          //       display the menu for the new comment form at the top.   
          $("#statusBar")[0].setAttribute('data-fileComment','newcomment')
          $("#statusBar")[0].setAttribute('data-fileCommentId',commentId)
          $(".statusBarMode")[0].innerHTML = "NEW COMMENT";
          // make the comment-specific tags menu return back to that of the pdf file when the mouse leaves the menu
          // temporarily replace the checkbox answers of the pdf fiole with that of the comment or "newcomment" at hand now:
          setTagMenuCheckboxes(commentId+'newcomment');
          // TEMPORARILY HIDE THE BUTTON THAT IS FOR GENERAL SUBMISSION THAT APPEARS ON THE RIGHT, in the top tag/editing/menu bar 
          turnOffButtons();
          // ready the form by clearing out the previous user note:
          $("#newCommentUsernote")[0].value = null;
          // populate the form with the selected quote and pass along other info such as the location of the comment
          $("#newCommentId")[0].innerHTML = commentId;
          $("#newCommentQuote")[0].value = selectedText;
          $("#newCommentCoords")[0].innerHTML = JSON.stringify(coords);
          // optimize the location where the new comment form pops up:
          // if the comment is in the upper left quadrant then fix the summary box upper left corner to be at x=0.5 and y=line that comment is on.
          // if                       lower left                                   lower left                 x=0.5     
          // if                       upper right                                  upper right                x=0.5     
          // if                       lower right                                  lower right                x=0.5  
          var nRects = fractRects.length;
          var screen = fractionToScreen({"x1":fractRects[0].x1, "y1":fractRects[0].y1, "x2":fractRects[nRects-1].x2, "y2":fractRects[nRects-1].y2});
          // convert to fractions of the entire screen (rather than of the canvas):
          $(".newCommentForm")[0].style.removeProperty("left");
          $(".newCommentForm")[0].style.removeProperty("right");
          $(".newCommentForm")[0].style.removeProperty("top");
          $(".newCommentForm")[0].style.removeProperty("bottom");
          // reveal the form to enter the new comment info such as additional user-inputted comments to accompany the quote, etc.
          // any action from henceforth is driven by the selections on this form
          $(".newCommentForm")[0].style.display = "block";
          var formRect = $(".newCommentForm")[0].getBoundingClientRect();
          var formWidth = formRect.width;
          var formHeight = formRect.height;
          var canvasBorders = canvas.getBoundingClientRect();
          var bottomControls = document.querySelector(".bottom-controls-container");
          var bottomRect = bottomControls.getBoundingClientRect();
          // position the form so that it does not get all smooshed up in the skinny margin if the pdf is taking up most of the space 
          if ((window.innerWidth - scrollbarWidth - canvasBorders.right) < formRect.width){
              $(".newCommentForm")[0].style.left = (window.innerWidth - scrollbarWidth - formRect.width - 5) + 'px';
          } else {
              $(".newCommentForm")[0].style.left = canvasBorders.right + 'px';
          }
          if ((window.innerHeight-bottomRect.height-screen.y1) >= formRect.height){
              $(".newCommentForm")[0].style.top = screen.y1 + 'px';
          } else {
              $(".newCommentForm")[0].style.top = (window.innerHeight-formRect.height-bottomRect.height) + 'px';
              // would be more straightforward to make this restriction on .bottom, but I found that when I set .bottom to a value, the pop up box is 
              // no longer able to be dragged/moved in the vertical direction. 
          }
          // https://www.w3schools.com/howto/tryit.asp?filename=tryhow_js_popup_form
       }
       /////////////////////////////////////  displayNewCommentForm ////////////////////////////////////////
       /////////////////////////////////////////////////////////////////////////////////////////////////////
          
       //////////////////////////////////////////////////////////////////////////////////////////////
       /////////////////////////////////////  turnOffButtons ////////////////////////////////////////
       function turnOffButtons(){
          $(".exitButtonContainer")[0].style.visibility = "hidden";          
          $(".btn-pagenext")[0].style.visibility = "hidden";
          $(".btn-pageprev")[0].style.visibility = "hidden";
          $(".makeComment")[0].style.visibility = "hidden";
          $(".makeHighlightOnly")[0].style.visibility = "hidden";
       }
       /////////////////////////////////////  turnOffButtons ////////////////////////////////////////
       //////////////////////////////////////////////////////////////////////////////////////////////
       
       //////////////////////////////////////////////////////////////////////////////////////////////
       //////////////////////////////////////  turnOnButtons ////////////////////////////////////////
       function turnOnButtons(){
          $(".exitButtonContainer")[0].style.visibility = "visible"; 
          $(".btn-pagenext")[0].style.visibility = "visible";
          $(".btn-pageprev")[0].style.visibility = "visible";
          $(".makeComment")[0].style.visibility = "visible";
          $(".makeHighlightOnly")[0].style.visibility = "visible";
       }
       //////////////////////////////////////  turnOnButtons ////////////////////////////////////////
       //////////////////////////////////////////////////////////////////////////////////////////////
       
       /////////////////////////////////////////////////////////////////////////////////////////////
       /////////////////////////////////////  hoverOverIcon ////////////////////////////////////////
       function hoverOverIcon(hideAfter, commentId) {
         // hide the tag summary box if the user has scrolled on past the comment and has not mouse-entered the box itself within 5 seconds
         setTimeout(function(){
            // if the mouse is on the fuzzy ball icon, then don't close out the summary box but instead add another "hideAfter" 
            if (!($(".commentForm")[0].getAttribute("data-hasEntered")) || $(".commentForm")[0].getAttribute("data-hasEntered")==""){
                // determine if the mouse is still hovering over fuzzy ball
                var hoverDiv = document.getElementById("tagSummaryHover" + commentId);
                if (hoverDiv.matches(':hover')){
                    clearTimeout();
                    // mouse is over the DIV element, so start another timeout
                    hoverOverIcon(hideAfter, commentId); 
                } else {
                    // time is up and the mouse has moved out of the comment area, so close the comment summary popup box
                    closeComment();
                    clearTimeout();
                }
            }
         }, hideAfter*1000);    
         // see https://www.tutorialrepublic.com/faq/how-to-check-if-the-mouse-is-over-an-element-in-jquery.php
       }
       /////////////////////////////////////  hoverOverIcon ////////////////////////////////////////
       /////////////////////////////////////////////////////////////////////////////////////////////
       
       ////////////////////////////////////////////////////////////////////////////////////////////
       /////////////////////////////////////  closeComment ////////////////////////////////////////
       function closeComment(){
          // set the data-hasEntered back to null
          $(".commentForm")[0].setAttribute("data-hasEntered",'');
          // hide the cancel and finish buttons and unhide the "edit" button:
          $(".cancelOrFinishButtonsContainer")[0].style.display = "none";
          $(".commentForm")[0].style.display = "none";
          $(".commentTagBtnContainer")[0].style.display = "block";
          // put the comment input form back into hiding
          // and restore its opacity so it's ready for the next comment:
          $(".commentForm")[0].style.opacity = "1";
          // restore the submit button at the very top of the menu  and others that were temporarily turned off
          turnOnButtons();
          // restore (if needed) the tag settings at the top to reflect those of the pdf file as a whole
          resetTagsToPdf();
       }
       /////////////////////////////////////  cancelComment ////////////////////////////////////////
       /////////////////////////////////////////////////////////////////////////////////////////////
       
       ////////////////////////////////////////////////////////////////////////////////////////////////
       /////////////////////////////////////  closeNewComment ////////////////////////////////////////
       function closeNewComment(cancelComment){
          // remove the temporary highlight entry
          var highlightStorage = JSON.parse($("#highlightStorage")[0].innerHTML);
          var nEntries = highlightStorage.length;
          highlightStorage = highlightStorage.slice(0,nEntries-1); // remove the last entry
          $("#highlightStorage")[0].innerHTML = JSON.stringify(highlightStorage);
          // put the new comment input form back into hiding
          $(".newCommentForm")[0].style.display = "none";
          // restore the submit button at the very top of the menu  and the others that were temporarily turned off
          turnOnButtons();
          // restore the tag settings at the top to reflect those of the pdf file as a whole
          resetTagsToPdf();
          // remove the highlight of the comment that was being made, since it has been now canceled, by reloading the document (the deleted
          // comment will not be in the storage area to be rendered)
          queueRenderPage(pageNum);
       }
       /////////////////////////////////////  closeNewComment ////////////////////////////////////////
       ////////////////////////////////////////////////////////////////////////////////////////////////
       
       //////////////////////////////////////////////////////////////////////////////////////////////////
       ///////////////////////////////  moveCommentInfoIntoStorage ///////////////////////////////////
       function moveCommentInfoIntoStorage(commentIdParam){
          var storedInfo = JSON.parse($("#hiddenStorage")[0].innerText);
          var tagLibrary = storedInfo.tagLibrary;
          var commentId = commentIdParam.replace(/^changeTags/,"").trim();
          // This function simply moves the information temporarily stored in the comment form into the stored info area. 
          var checkboxInfo = getCheckedTagIds(commentId);
          var theTagIds = checkboxInfo.tagIdList;
          var theTagNames = checkboxInfo.tagNameList;
          var promptText = "You must choose at least 1 tag for this comment in order to save the comment!";
          // If no tags have been checked, then throw up a warning and give user another chance to select a tag.
          if (theTagIds.length == 0){alert(promptText); return;}
          // -----------------------------------------------------------------------
          var quote = $("#recordedQuote")[0].value.trim();
          var usernote = $("#recordedUsernote")[0].value.trim();
          // determine if any changes have happened: 
          storedInfo[commentId].edited = false;
          if ((quote != storedInfo[commentId].quote) || (usernote != storedInfo[commentId].usernote) || (theTagIds.sort().join("|") != storedInfo[commentId].tagIdList.sort().join("|"))) {
              storedInfo[commentId].quote = quote;
              storedInfo[commentId].usernote = usernote;
              storedInfo[commentId].tagNameList = theTagNames;
              storedInfo[commentId].tagIdList = theTagIds
              storedInfo[commentId].edited = true; 
              var submitBtn = document.querySelector(".submitbtnOff");
              if (submitBtn && submitBtn !== undefined && submitBtn !== null){
                  submitBtn.className = "submitbtnOn";
                  document.querySelector(".exitbtnOn").className = "exitbtnOff";
              }
              $("#hiddenStorage")[0].innerText = JSON.stringify(storedInfo);
          }
          // ------------ close out the new commment form
          closeComment();
       }
       ///////////////////////////////  moveCommentInfoIntoStorage ///////////////////////////////////
       //////////////////////////////////////////////////////////////////////////////////////////////////

       //////////////////////////////////////////////////////////////////////////////////////////////////
       ///////////////////////////////  moveNewCommentInfoIntoStorage ///////////////////////////////////
       function moveNewCommentInfoIntoStorage(){
          var storedInfo = JSON.parse($("#hiddenStorage")[0].innerText);
          var tagLibrary = storedInfo.tagLibrary;
          // This function simply moves the information temporarily stored in the new comment form into a new-comment "queue" area, so that the comment form
          // can be used again for a different comment without overwriting the information for this comment. 
          var commentId = $("#statusBar")[0].getAttribute('data-fileCommentId');
          var checkboxInfo = getCheckedTagIds(commentId);
          var theTagIds = checkboxInfo.tagIdList;
          var theTagNames = checkboxInfo.tagNameList;
          var promptText = "You must choose at least 1 tag for this comment in order to save the comment!";
          // If no tags have been checked, then throw up a warning and give user another chance to select a tag.
          if (theTagIds.length == 0){alert(promptText); return;}
          // -----------------------------------------------------------------------
          var coords = JSON.parse($("#newCommentCoords")[0].innerHTML);
          var quote = $("#newCommentQuote")[0].value.trim();
          var usernote = $("#newCommentUsernote")[0].value.trim();
          storedInfo.commentIdList.push(commentId);
          storedInfo[commentId] = {
             "quote":quote, "usernote":usernote, "tagNameList":theTagNames, "tagIdList":theTagIds, "coords":coords, "edited":true}; 
          $("#hiddenStorage")[0].innerText = JSON.stringify(storedInfo);
          var submitBtn = document.querySelector(".submitbtnOff");
          if (submitBtn && submitBtn !== undefined && submitBtn !== null){
              submitBtn.className = "submitbtnOn";
              document.querySelector(".exitbtnOn").className = "exitbtnOff";
          }
          fillOutCommentPages();
          // ------------ close out the new commment form
          closeNewComment();
       }
       ///////////////////////////////  moveNewCommentInfoIntoStorage ///////////////////////////////////
       //////////////////////////////////////////////////////////////////////////////////////////////////

       //////////////////////////////////////////////////////////////////////////////////////////////////
       ////////////////////////////////////  setTagMenuCheckboxes ///////////////////////////////////////
       function setTagMenuCheckboxes(pdfOrComment){
          // this code is called  whenever the menu of tags along the top need to have the checkmarks initialized, to be specific to either the pdf file itself,
          // to a specific comment, or to be wiped clear and used as input for a new comment.  "pdfOrComment" is either "pdf", the comment id, or "newComment". 
          var storedInfo = JSON.parse($("#hiddenStorage")[0].innerText);
          var tagLibrary = storedInfo.tagLibrary;
          // if there are any flagged buttons, change them back to being unflagged for now
          var tagButtons = document.querySelectorAll(".dropdown-headerFlagged");
          if (tagButtons && tagButtons !== null && tagButtons.length > 0){for (let tagButton of tagButtons){tagButton.className = "dropdown-header";}}
          var tBoxes = document.getElementsByClassName("checkboxForTag");
          var tagBoxes = [];
          for (let tagBox of tBoxes){if (tagBox.id != "checkboxINSERTtagId"){tagBoxes.push(tagBox);}}
          // if we are leaving the tag edit menu set of checkboxes to change over to a comment, and the current checkbox set is 
          // for the pdf file as a whole, capture the settings and incorporate into the stored info array: 
          if ($("#statusBar")[0].getAttribute('data-fileCommentId') == 'pdf' && pdfOrComment != 'pdf'){uploadPdfTagsIntoStorage();}
          // uncheck all the boxes
          var mode = 'comment';
          if (pdfOrComment.toLowerCase() == 'pdf'){mode='pdf';}
          for (let tagBox of tagBoxes){tagBox.checked = false; tagBox.setAttribute('data-mode',mode);}
          var commentId = pdfOrComment.replace(/newcomment/,'');
          if (pdfOrComment == 'pdf'){
              $("#statusBar")[0].setAttribute('data-fileComment','file');
              $("#statusBar")[0].setAttribute('data-fileCommentId','pdf');
              $(".statusBarMode")[0].innerHTML = "WHOLE PAPER";
          } else if (pdfOrComment.match(/newcomment/)){
              $("#statusBar")[0].setAttribute('data-fileComment','newcomment');
              $("#statusBar")[0].setAttribute('data-fileCommentId',commentId);
              $(".statusBarMode")[0].innerHTML = "NEW COMMENT";
          } else {
              $("#statusBar")[0].setAttribute('data-fileComment','comment');
              $("#statusBar")[0].setAttribute('data-fileCommentId',commentId);
              $(".statusBarMode")[0].innerHTML = "COMMENT";
          }
          var tagIdList = [];
          if (!(pdfOrComment.match(/newcomment/)) && storedInfo[pdfOrComment] && storedInfo[pdfOrComment].tagIdList){
              var tagIdList = storedInfo[pdfOrComment].tagIdList;
          } else if (pdfOrComment.match(/newcomment/)){
              // get the tag list for the pdf file as a whole and pre-populate the tag menu with that list
              var tagIdList = storedInfo['pdf'].tagIdList;
          }
          // when you close or quit a comment summary box need to first make the one button "do you want to edit" button visible again  
          if (tagIdList && tagIdList.length > 0){
              for (let tagBox of tagBoxes){
                  var thisId = tagBox.id.replace(/^checkbox/,"").trim();
                  var indx = tagIdList.indexOf(thisId);
                  if (indx != -1){
                     tagBox.checked = true;
                     // change the color of the "button" for all parent Levels of this checkbox, to indicate that somewhere buried under the tag Level is a checked tag
                     // first, make sure that this tag is not itself the name of the sub-menu button:
                     if (tagLibrary[thisId].isSubMenu){
                         var parentElmt = document.getElementById("button"+thisId);
                         if (parentElmt && parentElmt !== null){parentElmt.className = 'dropdown-headerFlagged';}
                     }
                     var parentTagId = tagLibrary[thisId].parentTagId;
                     while (parentTagId != ''){
                         // find the button corresponding to this grouping of tags
                         var parentElmt = document.getElementById("button"+parentTagId);
                         if (parentElmt && parentElmt !== null){parentElmt.className = 'dropdown-headerFlagged';}
                         parentTagId = tagLibrary[parentTagId].parentTagId;
                     }
                  }              
              }
          }
       }
       ////////////////////////////////////  setTagMenuCheckboxes ///////////////////////////////////////
       //////////////////////////////////////////////////////////////////////////////////////////////////
       
       /////////////////////////////////////////////////////////////////////////////////////////
       ////////////////////////////////////  colorButton ///////////////////////////////////////
       function colorButton(checkboxIdParam){
          // if box goes from unchecked to checked, all buttons above this checkbox will be colored purple to indicate that
          // there is a checked box somewhere within the tag directory.  If the checkbox is a change to the situation when the paper
          // was first displayed, the save changes button in upper right will become bright red to indicate a change has been made. 
          // --> this task is NOT yet done here: The value of the checked box will be recorded in the cached file, under either "pdf" or the appropriate comment ID. 
          var storedInfo = JSON.parse($("#hiddenStorage")[0].innerText);
          var tagLibrary = storedInfo.tagLibrary;
          var isFlagged = false;
          var thisId = checkboxIdParam.replace(/^checkbox/,"").trim();
          var thisCheckBox = document.getElementById(checkboxIdParam);
          // =====================  determine the correct colors of involved tag category buttons =====================
          // determine if this checkbox is actually the name of the tag category.  If so, then need to color the button with the same name
          // (the "parent" will be the next button up, not the immediate button if this checkbox is the category itself)
          if (tagLibrary[thisId].isSubMenu){var parentTagId = thisId;} else {var parentTagId = tagLibrary[thisId].parentTagId;}
          while (parentTagId != ''){
              // find the button corresponding to this grouping of tags
              var parentElmt = document.getElementById("button"+parentTagId);
              if (parentElmt && parentElmt !== null){
                  var thisName = tagLibrary[parentTagId].fullName;
                  // now look at all the child-checkboxes under this button and if any one is checked then turn the 
                  // button to a flagged color.  Otherwise, unflagged color
                  if (!(isFlagged)){
                      var theseCheckboxes = document.querySelectorAll('[name^="'+thisName+'"]');
                      for (let k=0; k<theseCheckboxes.length; k++){
                          if (theseCheckboxes[k].checked){
                              isFlagged = true;
                              break;
                          }
                      }
                  }
                  if (isFlagged){parentElmt.className = 'dropdown-headerFlagged';} else {parentElmt.className = 'dropdown-header';} 
              }
              parentTagId = tagLibrary[parentTagId].parentTagId;
          }
          // =================== add the value of the checkbox to the relevant entity ("pdf" or a comment) =================
          // NOT YET IMPLEMENTED  (will require some restructuring ... and some simplification by removal of functions that will
          // no longer be needed once checkboxes are immediately assigned to the appropruiate entity)
          // ================== determine if the submit button needs to turn red ===================
          // if the check boxes are different than what they were for this entity when the pdf was initialy displayed, then
          // changes have indeed occurreed and the submit button needs to turn solid red
          var thisEntity = $("#statusBar")[0].getAttribute("data-fileCommentId");
          var buttonIsRed = false;
          var makeButtonRed = false;
          var submitBtnOn = document.querySelector(".submitbtnOn");
          if (submitBtnOn && submitBtnOn !== undefined && submitBtnOn !== null && submitBtnOn.innerHTML && submitBtnOn.innerHTML != ''){
              var buttonIsRed = true;
          } else {
              var buttonIsRed = false;
          }
          if (storedInfo.original[thisEntity] && storedInfo.original[thisEntity] !== undefined && storedInfo.original[thisEntity] !== null){
              var checkedTagInfo = getCheckedTagIds(thisEntity);
              var nowTagIdList = checkedTagInfo.tagIdList;
              nowTagIdList = ([... new Set(nowTagIdList)]).sort().join("|");
              var oldTagIdList = ([... new Set(storedInfo.original[thisEntity].tagIdList)]).sort().join("|");
              if (nowTagIdList != oldTagIdList){makeButtonRed = true;} else {makeButtonRed = false;}
          } 
          if (!(makeButtonRed) && buttonIsRed && storedInfo['pdf'].tagEdited){makeButtonRed = true;} 
          if (!(makeButtonRed) && buttonIsRed){for (let tagId of storedInfo.tagLibrary.tagIdList){if (storedInfo.tagLibrary[tagId].edited){makeButtonRed = true; break;}}}
          if (!(makeButtonRed) && buttonIsRed){for (let commentId of storedInfo.commentIdList){if (storedInfo[commentId].edited){makeButtonRed = true; break;}}}
          if (makeButtonRed && !(buttonIsRed)){
              document.querySelector(".submitbtnOff").className = "submitbtnOn";
              document.querySelector(".exitbtnOn").className = "exitbtnOff";
          } else if (!(makeButtonRed) && buttonIsRed){
              submitBtnOn.className = "submitbtnOff";
              document.querySelector(".exitbtnOff").className = "exitbtnOn";
          }
       }
       ////////////////////////////////////  colorButton ///////////////////////////////////////
       /////////////////////////////////////////////////////////////////////////////////////////
              
       ///////////////////////////////////////////////////////////////////////////////////////////
       //////////////////////////////////  getCheckedTagIds //////////////////////////////////////
       function getCheckedTagIds(forThisElementId){
          var storedInfo = JSON.parse($("#hiddenStorage")[0].innerText);
          // make sure that the tags displayed are those for forThisElementId (like 'pdf') and not for something else (like some other comment):
          var thisElementId = $("#statusBar")[0].getAttribute("data-fileCommentId");       
          if (thisElementId != forThisElementId){return {"tagIdList":[], "tagNameList":[]};}
          var theTagIds = [];
          var theTagNames = [];
          var tBoxes = document.getElementsByClassName("checkboxForTag");
          for (let tagBox of tBoxes){
              if (tagBox.id != "checkboxINSERTtagId" && tagBox.checked){
                 // get a list of the tags that have been assigned (the checkboxes that have been marked)
                 var tagId = tagBox.id.replace(/^checkbox/,"").trim();
                 theTagIds.push(tagId);
                 theTagNames.push(storedInfo.tagLibrary[tagId].fullName);
              }
          }
          return {"tagIdList":theTagIds, "tagNameList":theTagNames};
       }
       //////////////////////////////////  getCheckedTagIds //////////////////////////////////////
       ///////////////////////////////////////////////////////////////////////////////////////////
              
       //////////////////////////////////////////////////////////////////////////////////////////////////
       //////////////////////////////////  uploadPdfTagsIntoStorage //////////////////////////////////////
       function uploadPdfTagsIntoStorage(){
          var storedInfo = JSON.parse($("#hiddenStorage")[0].innerText);
          // This function simply moves the information in the checkboxes within the tag edit menu for the pdf file
          // as a whole into the storage area so that any changes made to the tags are not lost, when the tag area 
          // is used for a comment at a later time. 
          var theTagIds = getCheckedTagIds('pdf').tagIdList;
          if (theTagIds.length == 0){return;}
          // determine if any changes have been made in the tag assignments
          for (let tagId of theTagIds){if (storedInfo['pdf'].tagIdList.indexOf(tagId) == -1){storedInfo['pdf'].tagEdited = true;}}
          for (let tagId of storedInfo['pdf'].tagIdList){if (theTagIds.indexOf(tagId) == -1){storedInfo['pdf'].tagEdited = true;}}
          if (storedInfo['pdf'].tagEdited){
              var tagNameList = theTagIds.map(z => storedInfo.tagLibrary[z].fullName);
              var sortedIndices = getSortIndices(tagNameList);
              var tagNameList = sortedIndices.map(z => tagNameList[z]);
              var tagIdList = sortedIndices.map(z => theTagIds[z]);
              storedInfo['pdf'].tagIdList = tagIdList;
              storedInfo['pdf'].tagNameList = tagNameList;
              var submitBtn = document.querySelector(".submitbtnOff");
              if (submitBtn && submitBtn !== undefined && submitBtn !== null){
                  submitBtn.className = "submitbtnOn";
                  document.querySelector(".exitbtnOn").className = "exitbtnOff";
              }
          }
          $("#hiddenStorage")[0].innerText = JSON.stringify(storedInfo);
       }
       //////////////////////////////////  uploadPdfTagsIntoStorage //////////////////////////////////////
       //////////////////////////////////////////////////////////////////////////////////////////////////
       
       //////////////////////////////////////////////////////////////////////////////////////
       /////////////////////////////////////  busymode //////////////////////////////////////
       function busymode(message){
          $(".notBusy")[0].style.display = "none";
          $(".busy")[0].style.display = "block";
          // turn off all the buttons to insure that the user does not do anything until the changes have been processed. 
          document.querySelector(".btn-zoomout").style.visibility = 'hidden';
          document.querySelector(".btn-zoomin").style.visibility = 'hidden';
          document.querySelector(".btn-pageprev").style.visibility = 'hidden';
          document.querySelector(".btn-pagenext").style.visibility = 'hidden';
          document.querySelector(".makeHighlightOnly").style.visibility = 'hidden';
          document.querySelector(".makeComment").style.visibility = 'hidden';
          document.querySelector(".addgroup").style.visibility = 'hidden';
          document.querySelector(".exitButtonContainer").style.visibility = 'hidden';
          document.querySelector(".tagEditMenu").style.visibility = 'hidden';
          if (!(message) || message == "") {message = "BUSY";}
          $(".busy")[0].innerHTML = message;
       }
       //////////////////////////////////  busymode //////////////////////////////////////
       ///////////////////////////////////////////////////////////////////////////////////

       //////////////////////////////////////////////////////////////////////////////////////
       //////////////////////////////////  notBusymode //////////////////////////////////////
       function notBusymode(){
          $(".busy")[0].style.display = "none";
          $(".notBusy")[0].style.display = "block";
          document.querySelector(".btn-zoomout").style.visibility = 'visible';
          document.querySelector(".btn-zoomin").style.visibility = 'visible';
          document.querySelector(".btn-pageprev").style.visibility = 'visible';
          document.querySelector(".btn-pagenext").style.visibility = 'visible';
          document.querySelector(".makeHighlightOnly").style.visibility = 'visible';
          document.querySelector(".makeComment").style.visibility = 'visible';
          document.querySelector(".addgroup").style.visibility = 'visible';
          document.querySelector(".exitButtonContainer").style.visibility = 'visible';
          document.querySelector(".tagEditMenu").style.visibility = 'visible';
       }
       //////////////////////////////////  notBusymode //////////////////////////////////////
       //////////////////////////////////////////////////////////////////////////////////////

       //////////////////////////////////////////////////////////////////////////////////////////////////
       ///////////////////////////////////////  processChanges //////////////////////////////////////////
       function processChanges() {
          // When the "Process Changes" button at the top-right is pressed, this code executes and looks for any changes such as added or removed comments,
          // added or removed comment tags, added or removed pdf tags, and added level 1 and/or level 2 tags, and incorporates those changes into the pdf files
          // themselves to make the changes permanent.  Until the changes are incorporated into the pdf files, the changes only reside "in memory" while this code
          // is executing (e.g, the changes are noted in the hidden storage file, which dissappears if the browser window closes without hitting the Process Changes
          // button).  This code is the only one that directly interacts with Code.gs, providing it information regarding updates/changes. 
          // change the color of the button to show that something is happening.  Change the status bar on ALL of the 
          busymode('PROCESSING CHANGES');
          // make sure the tag edit menu settings match the tags stored for the pdf: 
          uploadPdfTagsIntoStorage();
          var storedInfo = $("#hiddenStorage")[0].innerText;
          // now make any changes "permanent" by implementing any changes into the pdf file's desription, and also making those changes in the 
          // bibtex and tag filter spreadsheets
          google.script.run
                .withSuccessHandler(function(updatedInfo){
                     $("#hiddenStorage")[0].innerText = updatedInfo;
                     notBusymode();
                     // need to refresh the page in order to replace any recently added comment ID embedded in the HTML links to the newly assigned google comment id
                     queueRenderPage(pageNum);
                     // exit
                     google.script.host.close();
                     google.script.host.editor.focus();
                 })
                .uploadChanges(storedInfo);
       };
       ////////////////////////////////////////  processChanges /////////////////////////////////////////
       //////////////////////////////////////////////////////////////////////////////////////////////////
              
       //////////////////////////////////////////////////////////////////////////////////////////////////
       ////////////////////////////////////////  getNewGroupName ////////////////////////////////////////
       function getNewGroupName() {
          // user is adding a LEVEL 1 tag category/Level.  The code below collects the information and stores it in the hidden storage, flagged
          // as new data, for later when it is submitted for processing, at which time a new Level will be made, etc. 
          var storedInfo = JSON.parse($("#hiddenStorage")[0].innerText);
          busymode('ADDING NEW TAG GROUP');
          var text = "Please enter a name for the new tag GROUP.\n(Your text will be turned into uppercase for the actual tag name.)";
          var newTagName = prompt(text);
          if ((!(newTagName)) || (newTagName === undefined) || (newTagName === null) || (newTagName == "null")){newTagName = '';}
          newTagName = newTagName.trim().toUpperCase();
          if (newTagName && newTagName != null && newTagName != "" && storedInfo.tagLibrary.tagNameList.indexOf(newTagName) == -1){
              // make a new/randomly-assigned ID number for this tag category
              var newTagId = generateIdNumber('t', 8, storedInfo.tagLibrary.tagIdList);
              storedInfo.tagLibrary.tagIdList.push(newTagId);
              storedInfo.tagLibrary.tagNameList.push(newTagName);
              storedInfo.tagLibrary[newTagId]={
                 "fullName":newTagName, "displayName":newTagName, "level":1, "parentTagId":'', "level1ParentId":'', "isSubMenu":true,"edited":true};
              storedInfo.tagLibrary[newTagName] = {"tagId":newTagId};
              var submitBtn = document.querySelector(".submitbtnOff");
              if (submitBtn && submitBtn !== undefined && submitBtn !== null){
                  submitBtn.className = "submitbtnOn";
                  document.querySelector(".exitbtnOn").className = "exitbtnOff";
              }
              $("#hiddenStorage")[0].innerText = JSON.stringify(storedInfo);
              createTagGroupDiv(newTagId);
              notBusymode();
          } else {
              notBusymode();
          }
       };
       ////////////////////////////////////////  getNewGroupName ////////////////////////////////////////
       //////////////////////////////////////////////////////////////////////////////////////////////////

       /////////////////////////////////////////////////////////////////////////////////////////////////////
       //////////////////////////////////////////  getNewTagName ///////////////////////////////////////////
       function getNewTagName(parentLevelParam) {
          var storedInfo = JSON.parse($("#hiddenStorage")[0].innerText);
          var parentTagId = parentLevelParam.replace(/^addtag/,"").trim();
          busymode('ADDING NEW TAG NAME');
          var text = "Please enter a name for the new desired tag under the category:\n     "+storedInfo.tagLibrary[parentTagId].fullName.replace(/\-\>/g,' \/ ')+
                     "\n(Your text will be turned into uppercase for the actual tag name.)";
          var newTagName = prompt(text);
          if ((!(newTagName)) || (newTagName === null) || (newTagName == "null")){newTagName = '';}
          newTagName = newTagName.trim().toUpperCase();          
          var fullTagName = storedInfo.tagLibrary[parentTagId].fullName + '\-\>' + newTagName;
          if (newTagName && newTagName != null && newTagName != "" && storedInfo.tagLibrary.tagNameList.indexOf(fullTagName) == -1){
              // make a new/randomly-assigned ID number for this tag category
              var newTagId = generateIdNumber('t', 8, storedInfo.tagLibrary.tagIdList);
              storedInfo.tagLibrary.tagIdList.push(newTagId);
              storedInfo.tagLibrary.tagNameList.push(fullTagName);
              var nLevel = fullTagName.split("\-\>").length;
              var level1ParentName = fullTagName.split("\-\>")[0];
              var level1ParentId = storedInfo.tagLibrary[level1ParentName].tagId;
              storedInfo.tagLibrary[newTagId]={
                 "fullName":fullTagName, "displayName":newTagName, "level":nLevel, "parentTagId":parentTagId, "level1ParentId":level1ParentId,"isSubMenu":false,"edited":true};
              storedInfo.tagLibrary[fullTagName] = {"tagId":newTagId};
              var submitBtn = document.querySelector(".submitbtnOff");
              if (submitBtn && submitBtn !== undefined && submitBtn !== null){
                  submitBtn.className = "submitbtnOn";
                  document.querySelector(".exitbtnOn").className = "exitbtnOff";
              }
              $("#hiddenStorage")[0].innerText = JSON.stringify(storedInfo);
              createTagCheckboxDiv(newTagId);
              notBusymode();
          } else {
              notBusymode();
          }
       };       
       //////////////////////////////////////////  getNewTagName ///////////////////////////////////////////
       /////////////////////////////////////////////////////////////////////////////////////////////////////
           
       /////////////////////////////////////////////////////////////////////////////////////////////////////
       ////////////////////////////////////////////  getSubmenu ////////////////////////////////////////////
       function getSubmenu(parentLevelParam) {
          var storedInfo = JSON.parse($("#hiddenStorage")[0].innerText);
          var parentTagId = parentLevelParam.replace(/^addSubmenu/,"").trim();
          busymode('ADDING NEW TAG SUB-CATEGORY');
          var text = "Please enter a name for the new desired tag sub-category under the category:\n      "+storedInfo.tagLibrary[parentTagId].fullName.replace(/\-\>/g,' \/ ')+
                     "\n(Your text will be turned into uppercase for the actual tag name.)";
          var newTagName = prompt(text);
          if ((!(newTagName)) || (newTagName === null) || (newTagName == "null")){newTagName = '';}
          newTagName= newTagName.trim().toUpperCase();
          var fullTagName = storedInfo.tagLibrary[parentTagId].fullName + '\-\>' + newTagName;
          if (newTagName && newTagName != null && newTagName != "" && storedInfo.tagLibrary.tagNameList.indexOf(fullTagName) == -1){
              // make a new/randomly-assigned ID number for this tag category
              var newTagId = generateIdNumber('t', 8, storedInfo.tagLibrary.tagIdList);
              storedInfo.tagLibrary.tagIdList.push(newTagId);
              storedInfo.tagLibrary.tagNameList.push(fullTagName);
              var nLevel = fullTagName.split("\-\>").length;
              var level1ParentName = fullTagName.split("\-\>")[0];
              var level1ParentId = storedInfo.tagLibrary[level1ParentName].tagId;
               storedInfo.tagLibrary[newTagId]={
                 "fullName":fullTagName, "displayName":newTagName, "level":nLevel, "parentTagId":parentTagId, "level1ParentId":level1ParentId, "isSubMenu":true,"edited":true};
              storedInfo.tagLibrary[fullTagName] = {"tagId":newTagId};
              var submitBtn = document.querySelector(".submitbtnOff");
              if (submitBtn && submitBtn !== undefined && submitBtn !== null){
                  submitBtn.className = "submitbtnOn";
                  document.querySelector(".exitbtnOn").className = "exitbtnOff";
              }
              $("#hiddenStorage")[0].innerText = JSON.stringify(storedInfo);
              createTagGroupDiv(newTagId);
              notBusymode();
          } else if (newTagName && storedInfo.tagLibrary.tagNameList.indexOf(fullTagName) != -1){
              var tagId = storedInfo.tagLibrary[fullTagName].tagId;
              if (!(storedInfo.tagLibrary[tagId].isSubMenu)){
                  // the tag used to be just a checkmark.  Now it is a submenu category
                  storedInfo.tagLibrary[tagId].isSubMenu = true;
                  storedInfo.tagLibrary[tagId].edited = true;
                  var submitBtn = document.querySelector(".submitbtnOff");
                  if (submitBtn && submitBtn !== undefined && submitBtn !== null){
                      submitBtn.className = "submitbtnOn";
                      document.querySelector(".exitbtnOn").className = "exitbtnOff";
                  }
                  $("#hiddenStorage")[0].innerText = JSON.stringify(storedInfo);
                  createTagGroupDiv(tagId);
              }
              notBusymode();
          } else {
              notBusymode();
          }
       };
       ////////////////////////////////////////////  getSubmenu ////////////////////////////////////////////
       /////////////////////////////////////////////////////////////////////////////////////////////////////

       /////////////////////////////////////////////////////////////////////////////////////////////////////  
       ///////////////////////////////////////  getSelectedTextArea ////////////////////////////////////////
       function getSelectedTextArea(){
          var sel = window.getSelection();
          var selectedText = sel.toString();
          if (selectedText.length < 5){return "error"}; // assume the selection was a mistake
          // make the selected text more readable by removing the carriage returns and removing the dashes at the end of the lines that break up words.
          // Some guidence will be needed to determine the few cases in which a dash is actually part of the real word. Let's just assume that if the number
          // of letters on either side of the dash is less than 7, then the dashed thing was just a word-split and the dash should be removed. 
          selectedText = selectedText.replace(/  +/g," ").replace(/ \-/g,"\-").replace(/\- /g,"\-");
          selectedText = selectedText.split(/\n/);
          for (let i=0; i<selectedText.length; i++){
              selectedText[i] = selectedText[i].trim();
              if (selectedText[i].match(/\-$/)){
                  var lettersBefore = selectedText[i].split(" ");
                  lettersBefore = lettersBefore[lettersBefore.length-1];
                  lettersBefore = lettersBefore.length;
                  var lettersAfter = 0;
                  if (i < selectedText.length-1){
                     var lettersAfter = selectedText[i+1].trim().split(" ");
                     lettersAfter = lettersAfter[0];
                     lettersAfter = lettersAfter.length;
                  }
                  if (lettersBefore < 7 && lettersAfter < 7 && lettersBefore > 2 && lettersAfter > 2){selectedText[i] = selectedText[i].replace(/\-$/,"");}
              }
          }
          selectedText = selectedText.join(" ").replace(/\- /g,"\-");
          var range = sel.getRangeAt(0);
          var rects = range.getClientRects();
          var screenRects;
          // remove the rects that are not associated with actual text (e.g., that have a length of 0)
          var nRects = 0;
          for (let i=0; i<rects.length; i++){
              if (rects[i].width && rects[i].width > 0){
                 if (nRects==0){
                     screenRects = [{"x1":rects[i].left, "y1":rects[i].top, "x2":rects[i].right, "y2":rects[i].bottom}];
                     nRects += 1;
                 } else if (screenRects[nRects-1].y1<=rects[i].top && screenRects[nRects-1].y2>rects[i].top && rects[i].right>screenRects[nRects-1].x2){
                     screenRects[nRects-1].x2 = rects[i].right;
                 } else if (screenRects[nRects-1].y2<=rects[i].top) {
                     screenRects.push({"x1":rects[i].left, "y1":rects[i].top, "x2":rects[i].right, "y2":rects[i].bottom});
                     nRects += 1;
                 }
              }
          }
          var canvasRects = [];
          var fractRects = [];
          var coords = [];
          var canvasBorders = canvas.getBoundingClientRect();
          var canvasWidth = canvasBorders.right - canvasBorders.left +1;
          var canvasHeight = canvasBorders.bottom - canvasBorders.top + 1;
          for (let i=0; i<screenRects.length; i++){
              canvasRects.push(screenToCanvas(screenRects[i]));
              fractRects.push(screenToFraction(screenRects[i]));
              var h2w = canvasHeight/canvasWidth;
              coords.push({"p":pageNum,"totPages":pdfDoc.numPages,"x1":fractRects[i].x1,"y1":fractRects[i].y1,"x2":fractRects[i].x2,"y2":fractRects[i].y2,"h2wRatio":h2w});
          }
          return JSON.stringify({"screenRects":screenRects, "canvasRects":canvasRects, "fractRects":fractRects, "coords":coords, "selectedText":selectedText});
       }
       ///////////////////////////////////////  getSelectedTextArea ////////////////////////////////////////
       /////////////////////////////////////////////////////////////////////////////////////////////////////
     
       ////////////////////////////////////////////////////////////////////////////////////////////////
       ///////////////////////////////////////  applyHighlight ////////////////////////////////////////
       function applyHighlight(fractRects, color){
          var canvasRects = fractRects.map(z => fractionToCanvas(z));
          for (let rect of canvasRects){
              ctx.fillStyle = color;
              ctx.fillRect(rect.x1, rect.y1, rect.x2-rect.x1, rect.y2-rect.y1);
          }
       }
       ///////////////////////////////////////  applyHighlight ////////////////////////////////////////
       ////////////////////////////////////////////////////////////////////////////////////////////////

       ///////////////////////////////////////////////////////////////////////////////////////////////////////
       /////////////////////////////////////  makeTagSummaryMouseOver ////////////////////////////////////////
       function makeTagSummaryMouseOver(fractRects, commentId){
          // https://stackoverflow.com/questions/4176923/html-of-selected-text
          // turn the fractional coordinates into canvas coordinates:
          var canvasRects = fractRects.map(z => fractionToCanvas(z));
          var nRects = fractRects.length;
          var buttonRadius = 15;
          var lineHeight = canvasRects[0].y2 - canvasRects[0].y1;
          if (fractRects[nRects-1].y1 != fractRects[0].y1){
             var xButton = canvasRects[0].x1; var yButton = canvasRects[0].y1;
          } else {
             var xButton = canvasRects[0].x1; var yButton = canvasRects[0].y2 - lineHeight/2 - buttonRadius;
          }
          try {
              var tagSummaryHoverButton = document.getElementById("tagSummaryHover" + commentId);
              tagSummaryHoverButton.setAttribute("style", "left:"+xButton+"px; top:"+yButton+"px");
              tagSummaryHoverButton.setAttribute("data-zoom", pdfScale);
          } catch(e){
              var tagSummaryHoverButton = document.createElement("button");
              tagSummaryHoverButton.className = "tagSummaryBtn";
              tagSummaryHoverButton.id = "tagSummaryHover" + commentId;
              tagSummaryHoverButton.setAttribute("style", "left:"+xButton+"px; top:"+yButton+"px");
              tagSummaryHoverButton.setAttribute("data-zoom", pdfScale);
              tagSummaryHoverButton.setAttribute("data-page", pageNum);
              var canvasContainer = document.querySelector(".canvas-container");
              canvasContainer.appendChild(tagSummaryHoverButton);
              var tagSummaryHoverButton = document.getElementById("tagSummaryHover" + commentId);
              tagSummaryHoverButton.addEventListener('mouseenter', function(){displayCommentForm(this.id)});
          }
          // https://stackoverflow.com/questions/35970851/cant-get-word-on-click
          // see https://www.w3schools.com/css/css_tooltip.asp
          // https://stackoverflow.com/questions/7627161/get-id-of-element-that-called-a-function
       }
       /////////////////////////////////////  makeTagSummaryMouseOver ////////////////////////////////////////
       ////////////////////////////////////////////////////////////////////////////////////////////////////////
              
       ////////////////////////////////////////////////////////////////////////////////////////////////////////
       //////////////////////////////////////  makeHighlightOnly ////////////////////////////////////////
       function makeHighlightOnly(){
          var tmp = getSelectedTextArea();
          if (tmp == "error"){alert("You didn't make a selection!"); return;}
          var tmp = JSON.parse(tmp);
          var screenRects = tmp.screenRects;
          var canvasRects = tmp.canvasRects;
          var fractRects = tmp.fractRects;
          var coords = tmp.coords;
          // make up a temporary id for the hjighlight
          var highlightId = new Date().toISOString();
          // color in the commented area
          applyHighlight(fractRects, highlightColor);
          //store the highlight information
          try {var highlightStorage = JSON.parse($("#highlightStorage")[0].innerHTML);} catch(e){var highlightStorage = [];}
          highlightStorage.push({"id":highlightId, "p":pageNum, "coords":coords});
          $("#highlightStorage")[0].innerHTML = JSON.stringify(highlightStorage);
       }
       //////////////////////////////////////  makeHighlightOnly ////////////////////////////////////////
       //////////////////////////////////////////////////////////////////////////////////////////////////
   
       //////////////////////////////////////////////////////////////////////////////////////////////////////////
       ///////////////////////////////////  resetTagsToPdf /////////////////////////////////////////////////
       function resetTagsToPdf(){
          setTagMenuCheckboxes('pdf');
       }
       /////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
                  
       ////////////////////////////////////////////////////////////////////////////////////////////////////////
       //////////////////////////////////////////  fractionToCanvas ///////////////////////////////////////////
       function fractionToCanvas(fractionCoords){
          var canvasRect = canvas.getBoundingClientRect();
          var canvasWidth = (canvasRect.right - canvasRect.left + 1);
          var canvasHeight = (canvasRect.bottom - canvasRect.top + 1);
          var canvasCoords = {};
          canvasCoords.x1 = fractionCoords.x1 * canvasWidth;
          canvasCoords.y1 = fractionCoords.y1 * canvasHeight;
          if (fractionCoords.x2 && fractionCoords.y2){
              canvasCoords.x2 = fractionCoords.x2 * canvasWidth;
              canvasCoords.y2 = fractionCoords.y2 * canvasHeight;
          }
          return canvasCoords;
       }
       ////////////////////////////////////////////////////////////////////////////////////////////////////////

       ////////////////////////////////////////////////////////////////////////////////////////////////////////
       //////////////////////////////////////////  canvasToFraction ///////////////////////////////////////////
       function canvasToFraction(canvasCoords){
          var canvasRect = canvas.getBoundingClientRect();
          var canvasWidth = (canvasRect.right - canvasRect.left + 1);
          var canvasHeight = (canvasRect.bottom - canvasRect.top + 1);
          var fractionCoords = {};
          fractionCoords.x1 = canvasCoords.x1 / canvasWidth;
          fractionCoords.y1 = canvasCoords.y1 / canvasHeight;
          if (canvasCoords.x2 && canvasCoords.y2){
              fractionCoords.x2 = canvasCoords.x2 / canvasWidth;
              fractionCoords.y2 = canvasCoords.y2 / canvasHeight;
          }
          return fractionCoords;
       }
       ////////////////////////////////////////////////////////////////////////////////////////////////////////
  
       ////////////////////////////////////////////////////////////////////////////////////////////////////////
       //////////////////////////////////////////  screenToFraction ///////////////////////////////////////////
       function screenToFraction(screenCoords){
          var canvasRect = canvas.getBoundingClientRect();
          var canvasWidth = (canvasRect.right - canvasRect.left + 1);
          var canvasHeight = (canvasRect.bottom - canvasRect.top + 1);
          var fractionCoords = {};
          fractionCoords.x1 = (screenCoords.x1 - canvasRect.left) / canvasWidth;
          fractionCoords.y1 = (screenCoords.y1 - canvasRect.top) / canvasHeight;
          if (screenCoords.x2 && screenCoords.y2){
              fractionCoords.x2 = (screenCoords.x2 - canvasRect.left) / canvasWidth;
              fractionCoords.y2 = (screenCoords.y2 - canvasRect.top) / canvasHeight;
          }
          return fractionCoords;
       }
       ////////////////////////////////////////////////////////////////////////////////////////////////////////
  
       ////////////////////////////////////////////////////////////////////////////////////////////////////////
       //////////////////////////////////////////  fractionToScreen ///////////////////////////////////////////
       function fractionToScreen(fractCoords){
          var canvasRect = canvas.getBoundingClientRect();
          var canvasWidth = (canvasRect.right - canvasRect.left + 1);
          var canvasHeight = (canvasRect.bottom - canvasRect.top + 1);
          var screenCoords = {};
          screenCoords.x1 = (fractCoords.x1 * canvasWidth) + canvasRect.left;
          screenCoords.y1 = (fractCoords.y1 * canvasHeight) + canvasRect.top;
          if (fractCoords.x2 && fractCoords.y2){
              screenCoords.x2 = (fractCoords.x2 * canvasWidth) + canvasRect.left;
              screenCoords.y2 = (fractCoords.y2 * canvasHeight) + canvasRect.top;
          }
          return screenCoords;
       }
       ////////////////////////////////////////////////////////////////////////////////////////////////////////
  
       ////////////////////////////////////////////////////////////////////////////////////////////////////////
       //////////////////////////////////////////  screenToCanvas ///////////////////////////////////////////
       function screenToCanvas(screenCoords){
          var canvasRect = canvas.getBoundingClientRect();
          var canvasCoords = {};
          canvasCoords.x1 = (screenCoords.x1 - canvasRect.left);
          canvasCoords.y1 = (screenCoords.y1 - canvasRect.top);
          if (screenCoords.x2 && screenCoords.y2){
              canvasCoords.x2 = (screenCoords.x2 - canvasRect.left); 
              canvasCoords.y2 = (screenCoords.y2 - canvasRect.top);
          }
          return canvasCoords;
       }
       ////////////////////////////////////////////////////////////////////////////////////////////////////////
    
       ////////////////////////////////////////////////////////////////////////////////////////////////////////
       /////////////////////////////////////////  getScrollbarWidth ///////////////////////////////////////////
       function getScrollbarWidth(){
          // determine if the browser being used takes the scrollbar into account already when determining
          // widths.  If the below is equal to zero, then scrollbar width is not first subtracted off when returning the 
          // width of the viewport: 
          var scrollbarWidth = (window.innerWidth - document.documentElement.clientWidth);
          if (scrollbarWidth == 0){
              var scrollbarHelper = document.getElementById('scrollbar-helper');
              var scrollbarWidth = scrollbarHelper.offsetWidth;
              scrollbarHelper.remove();
          }
	      return scrollbarWidth;
       }
       ////////////////////////////////////////////////////////////////////////////////////////////////////////

       //====================================================================================================================
       //          =========================== PDF.JS - SPECIFIC FUNCTIONS ===============================
       //====================================================================================================================
   
       //===========================================================================================================
       //=============================================  renderPage =================================================
       function renderPage(num) {
           pageRendering = true;
           // Using promise to fetch the page
           var scale = pdfScale;
           pdfDoc.getPage(num).then(function(page) {
               // Get page info from document, resize canvas accordingly, and render page. @param num Page number.
               var viewport = page.getViewport({scale: scale});
               canvas.height = viewport.height;
               canvas.width = viewport.width;           
               // Render PDF page into canvas context
               var renderContext = {canvasContext: ctx, viewport: viewport};
               var renderTask = page.render(renderContext);          
               // wait for rendering to finish
               renderTask.promise.then(function(){
                    pageRendering = false;
                    if (pageNumPending !== null){
                        // new page rendering is pending
                        renderPage(pageNumPending);
                        pageNumPending = null;
                    } 
               }).then(function() {
                    // Returns a promise, on resolving it will return text contents of the page
                    return page.getTextContent();
               }).then(function(textContent) {
                    // Assign CSS to the textLayer element
                    var textLayer = document.querySelector(".textLayer");
                    textLayer.style.left = canvas.offsetLeft + 'px';
                    textLayer.style.top = canvas.offsetTop + 'px';
                    textLayer.style.height = canvas.offsetHeight + 'px';
                    textLayer.style.width = canvas.offsetWidth + 'px'; 
                    // Pass the data to the method for rendering of text over the pdf canvas.
                    pdfjsLib.renderTextLayer({textContent: textContent, container: textLayer, viewport: viewport, textDivs: []});                 
               }).then(function(){   
                    var storedInfo = JSON.parse($("#hiddenStorage")[0].innerText);
                    var commentIdList = [];
                    if (storedInfo.commentIdList && storedInfo.commentIdList.length > 0){
                        // only get the comments associated with this page
                        commentIdList = storedInfo.commentIdList;
                        commentIdList = commentIdList.filter(z => storedInfo[z].coords[0].p == pageNum);
                    }
                    // remove any divs associated with comments from other pages, or from temporary comment IDs that have been replaced with google comment IDs
                    var tagSummaryHoverIcons = document.querySelectorAll(".tagSummaryBtn");
                    for (let tagSummaryHoverIcon of tagSummaryHoverIcons){
                        if ((tagSummaryHoverIcon.getAttribute("data-page") != pageNum) || 
                            (storedInfo.commentIdList.indexOf(tagSummaryHoverIcon.id.replace(/^tagSummaryHover/,"").trim()) == -1)){
                            // need to remove the event listener attached to this icon, I think
                            tagSummaryHoverIcon.removeEventListener('mouseenter', function(){displayCommentForm(this.id)});
                            tagSummaryHoverIcon.remove();
                        }
                    }                    
                    for (let commentId of commentIdList){
                        // color in the commented area
                        // if the comment is new and has not yet been permanently incorporated into the pdf file, then give it a different color from an established comment:
                        if (storedInfo[commentId].edited) {
                            applyHighlight(storedInfo[commentId].coords, newCommentColor);
                        } else {
                            applyHighlight(storedInfo[commentId].coords, commentColor);
                        }
                        // put in a little shadowy circle in the upper left corner of the highlighted comment to indicate where to click to get tag summary pop up box
                        makeTagSummaryMouseOver(storedInfo[commentId].coords, commentId);
                    }
                    // Now put down any highlight for selections that were highlighted but not intended for permanent comments
                    try {var highlightStorage = JSON.parse($("#highlightStorage")[0].innerHTML);} catch(e){var highlightStorage = [];}
                    if (highlightStorage && highlightStorage.length > 0){
                         // only get the highlights associated with this page
                         var highlightStorage = highlightStorage.filter(z => z.p == pageNum && (!(storedInfo[z.id])));
                         for (let highlightArea of highlightStorage){applyHighlight(highlightArea.coords, highlightColor);}
                    }
               });
           });  
           // Update page counters
           document.getElementById('page_num').value = num;       
       }
       //=============================================  renderPage =================================================
       //===========================================================================================================
    
       //======================================================================================================
       //=========================================  queueRenderPage ===========================================
       function queueRenderPage(num) {if (pageRendering) {pageNumPending = num;} else {renderPage(num);}}
         // If another page rendering in progress, waits until the rendering is finised. Otherwise, executes rendering immediately.
       //======================================================================================================
    
       //=============================================================================================
       //=========================================  zoomin ===========================================
       function zoomin() {pdfScale = pdfScale + 0.1; queueRenderPage(pageNum);}
       //=============================================================================================
    
       //=============================================================================================
       //========================================  zoomout ===========================================
       function zoomout() {pdfScale = pdfScale - 0.1; queueRenderPage(pageNum);}
       //=============================================================================================

       //=============================================================================================
       //=======================================  onPrevPage =========================================
       function onPrevPage() {if (pageNum <= 1) {return;}  pageNum--;  queueRenderPage(pageNum);}
         // Displays previous page.
       //=============================================================================================

       //=============================================================================================
       //=======================================  onNextPage =========================================
       function onNextPage() {if (pageNum >= pdfDoc.numPages) {return;} pageNum++; queueRenderPage(pageNum);}
         // Displays next page.
       //=============================================================================================
        
       //=============================================================================================
       //=======================================  runPdfJS ===========================================
       function runPdfJS(pdfData){
          pdfjsLib.getDocument({data: pdfData}).promise.then(function(pdfDoc_) {
              pdfDoc = pdfDoc_;
              document.getElementById('page_count').textContent = pdfDoc.numPages; 
              // limit the page options to the actual range within the pdf
              document.getElementById('page_num').setAttribute("max",pdfDoc.numPages)
              renderPage(pageNum);
          });
       }
       //=============================================================================================

       //========================================================================================================
       //             =========================== MAIN EXECUTABLE  ===============================
       //========================================================================================================
       //////////////////////////////////   GLOBAL CONSTANTS   /////////////////////////////////
        $(function(){$(".newCommentForm").draggable();});
        $(function(){$(".commentForm").draggable();});
        $(function(){$(".commentsOnThesePages").draggable();});
        var storedInfo = JSON.parse($("#hiddenStorage")[0].innerText);
        // first thing is to compute the width, in pixels, of the vertical scroll bar.  This width will be used 
        // to help optimize placement of the tag edit menu and some pop-up menus for comments: 
        var scrollbarWidth = getScrollbarWidth();
        var pdfId = JSON.parse($("#hiddenStorage")[0].innerText).pdfId;
        var pdfjsLib = window['pdfjs-dist/build/pdf'];
        var pdfDoc = null,
            pageNum = 1,
            pageRendering = false,
            pageNumPending = null,
            pdfScale = 1.3,
            canvas = document.getElementById('the-canvas'),
            ctx = canvas.getContext('2d');
        var highlightColor  = "rgba(255, 255, 0, 0.4)"; // yellow
        var commentColor    = "rgba(255, 0, 255, 0.4)"; // pink
        var newCommentColor = "rgba(0, 255, 255, 0.4)"; // aqua   
        // construct the tag edit menu container.  As different components are being viewed (the pdf file as a whole, a new 
        // comment, or an existing comment), the tag edit menu will display checked boxes relevant to that component. 
        generateTagEditMenu();
        // as default view, show the checkboxed tags of the pdf file itself. 
        setTagMenuCheckboxes('pdf');
        fillOutCommentPages();
        // add a listener to the "current page" text field so that users can directly jump to any page desired by typing in number nad hitting Enter key
        // see https://code.tutsplus.com/tutorials/how-to-create-a-pdf-viewer-in-javascript--cms-32505
        document.getElementById('page_num').addEventListener('keypress', (e) => {
           if (pdfDoc === null){return;}
           // get keyboard key code
           var keycode = (e.keyCode ? e.keyCode : e.which);
           // if code matches that of the Enter key ... 
           if (keycode == 13){
               var desiredPage = document.getElementById('page_num').valueAsNumber;
               if (desiredPage <= 0 || desiredPage > pdfDoc.numPages){return;}
               pageNum = desiredPage;
               queueRenderPage(pageNum);
           }
        });
        //https://stackoverflow.com/questions/33063213/pdf-js-with-text-selection
        // Create shortcut to access PDF.js exports.
        pdfjsLib.GlobalWorkerOptions.workerSrc = '//mozilla.github.io/pdf.js/build/pdf.worker.js';
        google.script
              .run
              .withSuccessHandler(function(base64Encoded) {var pdfData = atob(base64Encoded); runPdfJS(pdfData);})
              .withFailureHandler(function(e){console.log('Error: '+e.message);})
              .getPdfBase64Encoded(storedInfo);
      </script>
  </body>
</html> 
